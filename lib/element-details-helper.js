"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var attachElementDetailsToGlobal = function attachElementDetailsToGlobal() {
  var returnConstructElementDetails = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : false;

  var getAllAttributes = function getAllAttributes(element) {
    var attributeDetails = {};

    if (!element.attributes) {
      return {};
    }

    var attributes = Array.prototype.slice.call(element.attributes);
    attributes.forEach(function (attribute) {
      attributeDetails[attribute.nodeName] = attribute.nodeValue;
    });
    return attributeDetails;
  };

  var roundToOneDecimal = function roundToOneDecimal(number) {
    if (typeof number === 'string') {
      return number;
    }

    return Math.round(number * 10) / 10;
  };

  var getVisualDetails = function getVisualDetails(element) {
    var scrollTop = window.pageYOffset || (document.documentElement || document.body.parentNode || document.body).scrollTop;
    var scrollLeft = window.pageXOffset || (document.documentElement || document.body.parentNode || document.body).scrollLeft;
    var visualDetails = element.getBoundingClientRect();
    var x = roundToOneDecimal(scrollLeft + visualDetails.x);
    var y = roundToOneDecimal(scrollTop + visualDetails.y);
    var width = roundToOneDecimal(visualDetails.width);
    var height = roundToOneDecimal(visualDetails.height);
    return {
      x: x,
      y: y,
      width: width,
      height: height
    };
  };

  var constructParentsArray = function constructParentsArray(element) {
    var parentArray = [];
    var index = 0;

    if (!element.parentElement) {
      return parentArray;
    }

    element = element.parentElement;

    while (element !== null && index < 10) {
      index += 1;
      parentArray.push(getDirectDetails(element));
      element = element.parentElement;
    }

    return parentArray;
  };

  var constructDirectChildrenArray = function constructDirectChildrenArray(element) {
    var childrenArray = [];

    if (!element.children) {
      return null;
    }

    var children = Array.prototype.slice.call(element.children);
    children.forEach(function (child) {
      childrenArray.push({
        details: getDirectDetails(child),
        children: constructDirectChildrenArray(child)
      });
    });
    return childrenArray;
  };

  var constructElementDetails = function constructElementDetails(selector, testLineItemId) {
    var requestedByExtension = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : false;
    var domElement = document.querySelector(selector);

    if (!domElement || !window.trudonGlobals && !requestedByExtension) {
      return null;
    }

    var elementDetails = getDirectDetails(domElement);

    if (testLineItemId) {
      elementDetails.testLineItemId = testLineItemId;
    }

    elementDetails.visualDetails = getVisualDetails(domElement), elementDetails.selector = selector;
    elementDetails.nextSibling = domElement.nextElementSibling ? getDirectDetails(domElement.nextElementSibling) : null;
    elementDetails.previousSibling = domElement.previousElementSibling ? getDirectDetails(domElement.previousElementSibling) : null;
    elementDetails.parents = constructParentsArray(domElement);
    elementDetails.children = constructDirectChildrenArray(domElement);

    if (window.trudonGlobals) {
      elementDetails.currentElementGrade = window.trudonGlobals.selectorOptionsHelpers.getFinalGradeForElement(domElement, elementDetails);
    }

    return elementDetails;
  };

  var getDirectDetails = function getDirectDetails(element) {
    var withTextContent = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : true;
    return {
      tag: element.tagName,
      textContent: withTextContent && element.textContent ? element.textContent.replace(/[\n\r\s]+/g, '').substring(0, 128) : null,
      // trim to 128 characters and delete white spaces tabs and new lines
      numberOfPreviousSiblings: getPreviousSiblingsNumber(element),
      numberOfAfterSiblings: getNextSiblingsNumber(element),
      attributes: getAllAttributes(element)
    };
  };

  var getNextSiblingsNumber = function getNextSiblingsNumber(element) {
    var nextSiblings = 0;

    while (element.nextElementSibling && nextSiblings < 100) {
      if (element.nodeType === 3) {
        continue; // text node not included in nextElementSibling
      }

      element = element.nextElementSibling;
      nextSiblings += 1;
    }

    return nextSiblings;
  };

  var getPreviousSiblingsNumber = function getPreviousSiblingsNumber(element) {
    var previousSiblings = 0;

    while (element.previousElementSibling && previousSiblings < 100) {
      if (element.nodeType === 3) {
        continue; // text node not included in previousElementSibling
      }

      element = element.previousElementSibling;
      previousSiblings += 1;
    }

    return previousSiblings;
  };

  var addToGlobalVariable = function addToGlobalVariable(testLineItemDetails) {
    var elementDetails = constructElementDetails(testLineItemDetails.selector, testLineItemDetails.testLineItemId);

    if (window.trudonGlobals) {
      window.trudonGlobals.elementDetails.push(elementDetails);
    }

    return elementDetails;
  }; // we need constructElementDetails without other code to be exported for the extension part
  // but we need constructElementDetails in the browser execute too, that's why this happens.


  if (returnConstructElementDetails) {
    return constructElementDetails;
  }

  if (window.trudonGlobals) {
    return addToGlobalVariable(window.trudonGlobals.element);
  }
};

var _default = {
  attachElementDetailsToGlobal: attachElementDetailsToGlobal,
  constructElementDetails: attachElementDetailsToGlobal(true)
};
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImVsZW1lbnQtZGV0YWlscy1oZWxwZXIuanMiXSwibmFtZXMiOlsiYXR0YWNoRWxlbWVudERldGFpbHNUb0dsb2JhbCIsInJldHVybkNvbnN0cnVjdEVsZW1lbnREZXRhaWxzIiwiZ2V0QWxsQXR0cmlidXRlcyIsImVsZW1lbnQiLCJhdHRyaWJ1dGVEZXRhaWxzIiwiYXR0cmlidXRlcyIsIkFycmF5IiwicHJvdG90eXBlIiwic2xpY2UiLCJjYWxsIiwiZm9yRWFjaCIsImF0dHJpYnV0ZSIsIm5vZGVOYW1lIiwibm9kZVZhbHVlIiwicm91bmRUb09uZURlY2ltYWwiLCJudW1iZXIiLCJNYXRoIiwicm91bmQiLCJnZXRWaXN1YWxEZXRhaWxzIiwic2Nyb2xsVG9wIiwid2luZG93IiwicGFnZVlPZmZzZXQiLCJkb2N1bWVudCIsImRvY3VtZW50RWxlbWVudCIsImJvZHkiLCJwYXJlbnROb2RlIiwic2Nyb2xsTGVmdCIsInBhZ2VYT2Zmc2V0IiwidmlzdWFsRGV0YWlscyIsImdldEJvdW5kaW5nQ2xpZW50UmVjdCIsIngiLCJ5Iiwid2lkdGgiLCJoZWlnaHQiLCJjb25zdHJ1Y3RQYXJlbnRzQXJyYXkiLCJwYXJlbnRBcnJheSIsImluZGV4IiwicGFyZW50RWxlbWVudCIsInB1c2giLCJnZXREaXJlY3REZXRhaWxzIiwiY29uc3RydWN0RGlyZWN0Q2hpbGRyZW5BcnJheSIsImNoaWxkcmVuQXJyYXkiLCJjaGlsZHJlbiIsImNoaWxkIiwiZGV0YWlscyIsImNvbnN0cnVjdEVsZW1lbnREZXRhaWxzIiwic2VsZWN0b3IiLCJ0ZXN0TGluZUl0ZW1JZCIsInJlcXVlc3RlZEJ5RXh0ZW5zaW9uIiwiZG9tRWxlbWVudCIsInF1ZXJ5U2VsZWN0b3IiLCJ0cnVkb25HbG9iYWxzIiwiZWxlbWVudERldGFpbHMiLCJuZXh0U2libGluZyIsIm5leHRFbGVtZW50U2libGluZyIsInByZXZpb3VzU2libGluZyIsInByZXZpb3VzRWxlbWVudFNpYmxpbmciLCJwYXJlbnRzIiwiY3VycmVudEVsZW1lbnRHcmFkZSIsInNlbGVjdG9yT3B0aW9uc0hlbHBlcnMiLCJnZXRGaW5hbEdyYWRlRm9yRWxlbWVudCIsIndpdGhUZXh0Q29udGVudCIsInRhZyIsInRhZ05hbWUiLCJ0ZXh0Q29udGVudCIsInJlcGxhY2UiLCJzdWJzdHJpbmciLCJudW1iZXJPZlByZXZpb3VzU2libGluZ3MiLCJnZXRQcmV2aW91c1NpYmxpbmdzTnVtYmVyIiwibnVtYmVyT2ZBZnRlclNpYmxpbmdzIiwiZ2V0TmV4dFNpYmxpbmdzTnVtYmVyIiwibmV4dFNpYmxpbmdzIiwibm9kZVR5cGUiLCJwcmV2aW91c1NpYmxpbmdzIiwiYWRkVG9HbG9iYWxWYXJpYWJsZSIsInRlc3RMaW5lSXRlbURldGFpbHMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQSxJQUFJQSw0QkFBNEIsR0FBRyxTQUEvQkEsNEJBQStCLEdBQTJDO0FBQUEsTUFBMUNDLDZCQUEwQyx1RUFBVixLQUFVOztBQUM1RSxNQUFJQyxnQkFBZ0IsR0FBRyxTQUFuQkEsZ0JBQW1CLENBQVVDLE9BQVYsRUFBbUI7QUFDeEMsUUFBSUMsZ0JBQWdCLEdBQUcsRUFBdkI7O0FBRUEsUUFBSSxDQUFDRCxPQUFPLENBQUNFLFVBQWIsRUFBeUI7QUFDdkIsYUFBTyxFQUFQO0FBQ0Q7O0FBRUQsUUFBSUEsVUFBVSxHQUFHQyxLQUFLLENBQUNDLFNBQU4sQ0FBZ0JDLEtBQWhCLENBQXNCQyxJQUF0QixDQUEyQk4sT0FBTyxDQUFDRSxVQUFuQyxDQUFqQjtBQUNBQSxJQUFBQSxVQUFVLENBQUNLLE9BQVgsQ0FBbUIsVUFBVUMsU0FBVixFQUFxQjtBQUN0Q1AsTUFBQUEsZ0JBQWdCLENBQUNPLFNBQVMsQ0FBQ0MsUUFBWCxDQUFoQixHQUF1Q0QsU0FBUyxDQUFDRSxTQUFqRDtBQUNELEtBRkQ7QUFJQSxXQUFPVCxnQkFBUDtBQUNELEdBYkQ7O0FBZUEsTUFBSVUsaUJBQWlCLEdBQUcsU0FBcEJBLGlCQUFvQixDQUFVQyxNQUFWLEVBQWtCO0FBQ3hDLFFBQUksT0FBT0EsTUFB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ZW1lbnREZXRhaWxzVG9HbG9iYWwgPSAocmV0dXJuQ29uc3RydWN0RWxlbWVudERldGFpbHMgPSBmYWxzZSkgPT4ge1xuICB2YXIgZ2V0QWxsQXR0cmlidXRlcyA9IGZ1bmN0aW9uIChlbGVtZW50KSB7XG4gICAgdmFyIGF0dHJpYnV0ZURldGFpbHMgPSB7fTtcblxuICAgIGlmICghZWxlbWVudC5hdHRyaWJ1dGVzKSB7XG4gICAgICByZXR1cm4ge307XG4gICAgfVxuXG4gICAgdmFyIGF0dHJpYnV0ZXMgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChlbGVtZW50LmF0dHJpYnV0ZXMpO1xuICAgIGF0dHJpYnV0ZXMuZm9yRWFjaChmdW5jdGlvbiAoYXR0cmlidXRlKSB7XG4gICAgICBhdHRyaWJ1dGVEZXRhaWxzW2F0dHJpYnV0ZS5ub2RlTmFtZV0gPSBhdHRyaWJ1dGUubm9kZVZhbHVlO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIGF0dHJpYnV0ZURldGFpbHM7XG4gIH07XG5cbiAgdmFyIHJvdW5kVG9PbmVEZWNpbWFsID0gZnVuY3Rpb24gKG51bWJlcikge1xuICAgIGlmICh0eXBlb2YgbnVtYmVyID09PSAnc3RyaW5nJykge1xuICAgICAgcmV0dXJuIG51bWJlcjtcbiAgICB9XG5cbiAgICByZXR1cm4gTWF0aC5yb3VuZChudW1iZXIgKiAxMCkgLyAxMDtcbiAgfTtcblxuICB2YXIgZ2V0VmlzdWFsRGV0YWlscyA9IGZ1bmN0aW9uIChlbGVtZW50KSB7XG4gICAgdmFyIHNjcm9sbFRvcCA9IHdpbmRvdy5wYWdlWU9mZnNldCB8fFxuICAgICAgKFxuICAgICAgICBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQgfHxcbiAgICAgICAgZG9jdW1lbnQuYm9keS5wYXJlbnROb2RlIHx8XG4gICAgICAgIGRvY3VtZW50LmJvZHlcbiAgICAgICkuc2Nyb2xsVG9wO1xuXG4gICAgdmFyIHNjcm9sbExlZnQgPSB3aW5kb3cucGFnZVhPZmZzZXQgfHxcbiAgICAgIChcbiAgICAgICAgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50IHx8XG4gICAgICAgIGRvY3VtZW50LmJvZHkucGFyZW50Tm9kZSB8fFxuICAgICAgICBkb2N1bWVudC5ib2R5XG4gICAgICApLnNjcm9sbExlZnQ7XG5cbiAgICB2YXIgdmlzdWFsRGV0YWlscyA9IGVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG4gICAgY29uc3QgeCA9IHJvdW5kVG9PbmVEZWNpbWFsKHNjcm9sbExlZnQgKyB2aXN1YWxEZXRhaWxzLngpO1xuICAgIGNvbnN0IHkgPSByb3VuZFRvT25lRGVjaW1hbChzY3JvbGxUb3AgKyB2aXN1YWxEZXRhaWxzLnkpO1xuICAgIGNvbnN0IHdpZHRoID0gcm91bmRUb09uZURlY2ltYWwodmlzdWFsRGV0YWlscy53aWR0aCk7XG4gICAgY29uc3QgaGVpZ2h0ID0gcm91bmRUb09uZURlY2ltYWwodmlzdWFsRGV0YWlscy5oZWlnaHQpO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHg6IHgsIHk6IHksIHdpZHRoOiB3aWR0aCwgaGVpZ2h0OiBoZWlnaHQsXG4gICAgfTtcbiAgfTtcblxuICB2YXIgY29uc3RydWN0UGFyZW50c0FycmF5ID0gZnVuY3Rpb24gKGVsZW1lbnQpIHtcbiAgICB2YXIgcGFyZW50QXJyYXkgPSBbXTtcbiAgICB2YXIgaW5kZXggPSAwO1xuXG4gICAgaWYgKCFlbGVtZW50LnBhcmVudEVsZW1lbnQpIHtcbiAgICAgIHJldHVybiBwYXJlbnRBcnJheTtcbiAgICB9XG5cbiAgICBlbGVtZW50ID0gZWxlbWVudC5wYXJlbnRFbGVtZW50O1xuXG4gICAgd2hpbGUgKGVsZW1lbnQgIT09IG51bGwgJiYgaW5kZXggPCAxMCkge1xuICAgICAgaW5kZXggKz0gMTtcbiAgICAgIHBhcmVudEFycmF5LnB1c2goZ2V0RGlyZWN0RGV0YWlscyhlbGVtZW50KSk7XG5cbiAgICAgIGVsZW1lbnQgPSBlbGVtZW50LnBhcmVudEVsZW1lbnQ7XG4gICAgfVxuXG4gICAgcmV0dXJuIHBhcmVudEFycmF5O1xuICB9O1xuXG4gIHZhciBjb25zdHJ1Y3REaXJlY3RDaGlsZHJlbkFycmF5ID0gZnVuY3Rpb24gKGVsZW1lbnQpIHtcbiAgICB2YXIgY2hpbGRyZW5BcnJheSA9IFtdO1xuXG4gICAgaWYgKCFlbGVtZW50LmNoaWxkcmVuKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICB2YXIgY2hpbGRyZW4gPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChlbGVtZW50LmNoaWxkcmVuKTtcblxuICAgIGNoaWxkcmVuLmZvckVhY2goZnVuY3Rpb24gKGNoaWxkKSB7XG4gICAgICBjaGlsZHJlbkFycmF5LnB1c2goe1xuICAgICAgICBkZXRhaWxzOiBnZXREaXJlY3REZXRhaWxzKGNoaWxkKSxcbiAgICAgICAgY2hpbGRyZW46IGNvbnN0cnVjdERpcmVjdENoaWxkcmVuQXJyYXkoY2hpbGQpLFxuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICByZXR1cm4gY2hpbGRyZW5BcnJheTtcbiAgfTtcblxuICB2YXIgY29uc3RydWN0RWxlbWVudERldGFpbHMgPSBmdW5jdGlvbiAoc2VsZWN0b3IsIHRlc3RMaW5lSXRlbUlkLCByZXF1ZXN0ZWRCeUV4dGVuc2lvbiA9IGZhbHNlKSB7XG4gICAgdmFyIGRvbUVsZW1lbnQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKHNlbGVjdG9yKTtcblxuICAgIGlmICghZG9tRWxlbWVudCB8fCAoIXdpbmRvdy50cnVkb25HbG9iYWxzICYmICFyZXF1ZXN0ZWRCeUV4dGVuc2lvbikpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIHZhciBlbGVtZW50RGV0YWlscyA9IGdldERpcmVjdERldGFpbHMoZG9tRWxlbWVudCk7XG4gICAgaWYgKHRlc3RMaW5lSXRlbUlkKSB7XG4gICAgICBlbGVtZW50RGV0YWlscy50ZXN0TGluZUl0ZW1JZCA9IHRlc3RMaW5lSXRlbUlkO1xuICAgIH1cbiAgICBlbGVtZW50RGV0YWlscy52aXN1YWxEZXRhaWxzID0gZ2V0VmlzdWFsRGV0YWlscyhkb21FbGVtZW50KSxcbiAgICBlbGVtZW50RGV0YWlscy5zZWxlY3RvciA9IHNlbGVjdG9yO1xuICAgIGVsZW1lbnREZXRhaWxzLm5leHRTaWJsaW5nID0gZG9tRWxlbWVudC5uZXh0RWxlbWVudFNpYmxpbmcgPyBnZXREaXJlY3REZXRhaWxzKGRvbUVsZW1lbnQubmV4dEVsZW1lbnRTaWJsaW5nKSA6IG51bGw7XG4gICAgZWxlbWVudERldGFpbHMucHJldmlvdXNTaWJsaW5nID0gZG9tRWxlbWVudC5wcmV2aW91c0VsZW1lbnRTaWJsaW5nID8gZ2V0RGlyZWN0RGV0YWlscyhkb21FbGVtZW50LnByZXZpb3VzRWxlbWVudFNpYmxpbmcpIDogbnVsbDtcbiAgICBlbGVtZW50RGV0YWlscy5wYXJlbnRzID0gY29uc3RydWN0UGFyZW50c0FycmF5KGRvbUVsZW1lbnQpO1xuICAgIGVsZW1lbnREZXRhaWxzLmNoaWxkcmVuID0gY29uc3RydWN0RGlyZWN0Q2hpbGRyZW5BcnJheShkb21FbGVtZW50KTtcbiAgICBpZiAod2luZG93LnRydWRvbkdsb2JhbHMpIHtcbiAgICAgIGVsZW1lbnREZXRhaWxzLmN1cnJlbnRFbGVtZW50R3JhZGUgPSB3aW5kb3cudHJ1ZG9uR2xvYmFscy5zZWxlY3Rvck9wdGlvbnNIZWxwZXJzLmdldEZpbmFsR3JhZGVGb3JFbGVtZW50KGRvbUVsZW1lbnQsIGVsZW1lbnREZXRhaWxzKTtcbiAgICB9XG5cbiAgICByZXR1cm4gZWxlbWVudERldGFpbHM7XG4gIH07XG5cbiAgdmFyIGdldERpcmVjdERldGFpbHMgPSBmdW5jdGlvbiAoZWxlbWVudCwgd2l0aFRleHRDb250ZW50ID0gdHJ1ZSkge1xuICAgIHJldHVybiB7XG4gICAgICB0YWc6IGVsZW1lbnQudGFnTmFtZSxcbiAgICAgIHRleHRDb250ZW50OiB3aXRoVGV4dENvbnRlbnQgJiYgZWxlbWVudC50ZXh0Q29udGVudCA/IGVsZW1lbnQudGV4dENvbnRlbnQucmVwbGFjZSgvW1xcblxcclxcc10rL2csICcnKS5zdWJzdHJpbmcoMCwgMTI4KSA6IG51bGwsIC8vIHRyaW0gdG8gMTI4IGNoYXJhY3RlcnMgYW5kIGRlbGV0ZSB3aGl0ZSBzcGFjZXMgdGFicyBhbmQgbmV3IGxpbmVzXG4gICAgICBudW1iZXJPZlByZXZpb3VzU2libGluZ3M6IGdldFByZXZpb3VzU2libGluZ3NOdW1iZXIoZWxlbWVudCksXG4gICAgICBudW1iZXJPZkFmdGVyU2libGluZ3M6IGdldE5leHRTaWJsaW5nc051bWJlcihlbGVtZW50KSxcbiAgICAgIGF0dHJpYnV0ZXM6IGdldEFsbEF0dHJpYnV0ZXMoZWxlbWVudCksXG4gICAgfTtcbiAgfTtcblxuICB2YXIgZ2V0TmV4dFNpYmxpbmdzTnVtYmVyID0gZnVuY3Rpb24gKGVsZW1lbnQpIHtcbiAgICB2YXIgbmV4dFNpYmxpbmdzID0gMDtcblxuICAgIHdoaWxlIChlbGVtZW50Lm5leHRFbGVtZW50U2libGluZyAmJiBuZXh0U2libGluZ3MgPCAxMDApIHtcbiAgICAgIGlmIChlbGVtZW50Lm5vZGVUeXBlID09PSAzKSB7XG4gICAgICAgIGNvbnRpbnVlOyAvLyB0ZXh0IG5vZGUgbm90IGluY2x1ZGVkIGluIG5leHRFbGVtZW50U2libGluZ1xuICAgICAgfVxuICAgICAgZWxlbWVudCA9IGVsZW1lbnQubmV4dEVsZW1lbnRTaWJsaW5nO1xuXG4gICAgICBuZXh0U2libGluZ3MgKz0gMTtcbiAgICB9XG5cbiAgICByZXR1cm4gbmV4dFNpYmxpbmdzO1xuICB9O1xuXG4gIHZhciBnZXRQcmV2aW91c1NpYmxpbmdzTnVtYmVyID0gZnVuY3Rpb24gKGVsZW1lbnQpIHtcbiAgICB2YXIgcHJldmlvdXNTaWJsaW5ncyA9IDA7XG5cbiAgICB3aGlsZSAoZWxlbWVudC5wcmV2aW91c0VsZW1lbnRTaWJsaW5nICYmIHByZXZpb3VzU2libGluZ3MgPCAxMDApIHtcbiAgICAgIGlmIChlbGVtZW50Lm5vZGVUeXBlID09PSAzKSB7XG4gICAgICAgIGNvbnRpbnVlOyAvLyB0ZXh0IG5vZGUgbm90IGluY2x1ZGVkIGluIHByZXZpb3VzRWxlbWVudFNpYmxpbmdcbiAgICAgIH1cbiAgICAgIGVsZW1lbnQgPSBlbGVtZW50LnByZXZpb3VzRWxlbWVudFNpYmxpbmc7XG5cbiAgICAgIHByZXZpb3VzU2libGluZ3MgKz0gMTtcbiAgICB9XG5cbiAgICByZXR1cm4gcHJldmlvdXNTaWJsaW5ncztcbiAgfTtcblxuICB2YXIgYWRkVG9HbG9iYWxWYXJpYWJsZSA9IGZ1bmN0aW9uICh0ZXN0TGluZUl0ZW1EZXRhaWxzKSB7XG4gICAgdmFyIGVsZW1lbnREZXRhaWxzID0gY29uc3RydWN0RWxlbWVudERldGFpbHModGVzdExpbmVJdGVtRGV0YWlscy5zZWxlY3RvciwgdGVzdExpbmVJdGVtRGV0YWlscy50ZXN0TGluZUl0ZW1JZCk7XG4gICAgaWYgKHdpbmRvdy50cnVkb25HbG9iYWxzKSB7XG4gICAgICB3aW5kb3cudHJ1ZG9uR2xvYmFscy5lbGVtZW50RGV0YWlscy5wdXNoKGVsZW1lbnREZXRhaWxzKTtcbiAgICB9XG5cbiAgICByZXR1cm4gZWxlbWVudERldGFpbHM7XG4gIH07XG5cbiAgLy8gd2UgbmVlZCBjb25zdHJ1Y3RFbGVtZW50RGV0YWlscyB3aXRob3V0IG90aGVyIGNvZGUgdG8gYmUgZXhwb3J0ZWQgZm9yIHRoZSBleHRlbnNpb24gcGFydFxuICAvLyBidXQgd2UgbmVlZCBjb25zdHJ1Y3RFbGVtZW50RGV0YWlscyBpbiB0aGUgYnJvd3NlciBleGVjdXRlIHRvbywgdGhhdCdzIHdoeSB0aGlzIGhhcHBlbnMuXG4gIGlmIChyZXR1cm5Db25zdHJ1Y3RFbGVtZW50RGV0YWlscykge1xuICAgIHJldHVybiBjb25zdHJ1Y3RFbGVtZW50RGV0YWlscztcbiAgfVxuXG4gIGlmICh3aW5kb3cudHJ1ZG9uR2xvYmFscykge1xuICAgIHJldHVybiBhZGRUb0dsb2JhbFZhcmlhYmxlKHdpbmRvdy50cnVkb25HbG9iYWxzLmVsZW1lbnQpO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IHtcbiAgYXR0YWNoRWxlbWVudERldGFpbHNUb0dsb2JhbCxcbiAgY29uc3RydWN0RWxlbWVudERldGFpbHM6IGF0dGFjaEVsZW1lbnREZXRhaWxzVG9HbG9iYWwodHJ1ZSksXG59O1xuIl0sImZpbGUiOiJlbGVtZW50LWRldGFpbHMtaGVscGVyLmpzIn0=
