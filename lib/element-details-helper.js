"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var getAllAttributes = function getAllAttributes(element) {
  var attributeDetails = {};

  if (!element.attributes) {
    return {};
  }

  var attributes = Array.prototype.slice.call(element.attributes);
  attributes.forEach(function (attribute) {
    attributeDetails[attribute.nodeName] = attribute.nodeValue;
  });
  return attributeDetails;
};

var constructParentsArray = function constructParentsArray(element) {
  var parentArray = [];
  var index = 0;

  if (!element.parentElement) {
    return parentArray;
  }

  element = element.parentElement;

  while (element !== null && index < 10) {
    index += 1;
    parentArray.push(getDirectDetails(element));
    element = element.parentElement;
  }

  return parentArray;
};

var constructDirectChildrenArray = function constructDirectChildrenArray(element) {
  var childrenArray = [];

  if (!element.children) {
    return null;
  }

  var children = Array.prototype.slice.call(element.children);
  children.forEach(function (child) {
    childrenArray.push({
      details: getDirectDetails(child),
      children: constructDirectChildrenArray(child)
    });
  });
  return childrenArray;
};

var constructElementDetails = function constructElementDetails(selector, testLineItemId) {
  var domElement = document.querySelector(selector);

  if (!domElement || !window.trudonGlobals) {
    return null;
  }

  var elementDetails = getDirectDetails(domElement);

  if (testLineItemId) {
    elementDetails.testLineItemId = testLineItemId;
  }

  elementDetails.selector = selector;
  elementDetails.nextSibling = domElement.nextElementSibling ? getDirectDetails(domElement.nextElementSibling) : null;
  elementDetails.previousSibling = domElement.previousElementSibling ? getDirectDetails(domElement.previousElementSibling) : null;
  elementDetails.parents = constructParentsArray(domElement);
  elementDetails.children = constructDirectChildrenArray(domElement);

  if (window.trudonGlobals) {
    elementDetails.currentElementGrade = window.trudonGlobals.selectorOptionsHelpers.getFinalGradeForElement(domElement, elementDetails);
  }

  return elementDetails;
};

var getDirectDetails = function getDirectDetails(element) {
  var withTextContent = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : true;
  return {
    tag: element.tagName,
    textContent: withTextContent && element.textContent ? element.textContent.replace(/[\n\r\s]+/g, '').substring(0, 128) : null,
    // trim to 128 characters and delete white spaces tabs and new lines
    numberOfPreviousSiblings: getPreviousSiblingsNumber(element),
    numberOfAfterSiblings: getNextSiblingsNumber(element),
    attributes: getAllAttributes(element)
  };
};

var getNextSiblingsNumber = function getNextSiblingsNumber(element) {
  var nextSiblings = 0;

  while (element.nextElementSibling && nextSiblings < 100) {
    if (element.nodeType === 3) {
      continue; // text node not included in nextElementSibling
    }

    element = element.nextElementSibling;
    nextSiblings += 1;
  }

  return nextSiblings;
};

var getPreviousSiblingsNumber = function getPreviousSiblingsNumber(element) {
  var previousSiblings = 0;

  while (element.previousElementSibling && previousSiblings < 100) {
    if (element.nodeType === 3) {
      continue; // text node not included in previousElementSibling
    }

    element = element.previousElementSibling;
    previousSiblings += 1;
  }

  return previousSiblings;
};

var addToGlobalVariable = function addToGlobalVariable(testLineItemDetails) {
  var elementDetails = constructElementDetails(testLineItemDetails.selector, testLineItemDetails.testLineItemId);

  if (window.trudonGlobals) {
    window.trudonGlobals.elementDetails.push(elementDetails);
  }

  return elementDetails;
};

var attachElementDetailsToGlobal = function attachElementDetailsToGlobal() {
  if (window.trudonGlobals) {
    return addToGlobalVariable(window.trudonGlobals.element);
  }
};

var _default = {
  attachElementDetailsToGlobal: attachElementDetailsToGlobal,
  constructElementDetails: constructElementDetails
};
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImVsZW1lbnQtZGV0YWlscy1oZWxwZXIuanMiXSwibmFtZXMiOlsiZ2V0QWxsQXR0cmlidXRlcyIsImVsZW1lbnQiLCJhdHRyaWJ1dGVEZXRhaWxzIiwiYXR0cmlidXRlcyIsIkFycmF5IiwicHJvdG90eXBlIiwic2xpY2UiLCJjYWxsIiwiZm9yRWFjaCIsImF0dHJpYnV0ZSIsIm5vZGVOYW1lIiwibm9kZVZhbHVlIiwiY29uc3RydWN0UGFyZW50c0FycmF5IiwicGFyZW50QXJyYXkiLCJpbmRleCIsInBhcmVudEVsZW1lbnQiLCJwdXNoIiwiZ2V0RGlyZWN0RGV0YWlscyIsImNvbnN0cnVjdERpcmVjdENoaWxkcmVuQXJyYXkiLCJjaGlsZHJlbkFycmF5IiwiY2hpbGRyZW4iLCJjaGlsZCIsImRldGFpbHMiLCJjb25zdHJ1Y3RFbGVtZW50RGV0YWlscyIsInNlbGVjdG9yIiwidGVzdExpbmVJdGVtSWQiLCJkb21FbGVtZW50IiwiZG9jdW1lbnQiLCJxdWVyeVNlbGVjdG9yIiwid2luZG93IiwidHJ1ZG9uR2xvYmFscyIsImVsZW1lbnREZXRhaWxzIiwibmV4dFNpYmxpbmciLCJuZXh0RWxlbWVudFNpYmxpbmciLCJwcmV2aW91c1NpYmxpbmciLCJwcmV2aW91c0VsZW1lbnRTaWJsaW5nIiwicGFyZW50cyIsImN1cnJlbnRFbGVtZW50R3JhZGUiLCJzZWxlY3Rvck9wdGlvbnNIZWxwZXJzIiwiZ2V0RmluYWxHcmFkZUZvckVsZW1lbnQiLCJ3aXRoVGV4dENvbnRlbnQiLCJ0YWciLCJ0YWdOYW1lIiwidGV4dENvbnRlbnQiLCJyZXBsYWNlIiwic3Vic3RyaW5nIiwibnVtYmVyT2ZQcmV2aW91c1NpYmxpbmdzIiwiZ2V0UHJldmlvdXNTaWJsaW5nc051bWJlciIsIm51bWJlck9mQWZ0ZXJTaWJsaW5ncyIsImdldE5leHRTaWJsaW5nc051bWJlciIsIm5leHRTaWJsaW5ncyIsIm5vZGVUeXBlIiwicHJldmlvdXNTaWJsaW5ncyIsImFkZFRvR2xvYmFsVmFyaWFi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QUFyQixDQUFvQ2YsSUFBcEMsQ0FBeUNlLGNBQXpDO0FBQ0Q7O0FBRUQsU0FBT0EsY0FBUDtBQUNELENBUEQ7O0FBU0EsSUFBSXdCLDRCQUE0QixHQUFHLFNBQS9CQSw0QkFBK0IsR0FBTTtBQUN2QyxNQUFJMUIsTUFBTSxDQUFDQyxhQUFYLEVBQTBCO0FBQ3hCLFdBQU91QixtQkFBbUIsQ0FBQ3hCLE1BQU0sQ0FBQ0MsYUFBUCxDQUFxQjdCLE9BQXRCLENBQTFCO0FBQ0Q7QUFDRixDQUpEOztlQU1lO0FBQ2JzRCxFQUFBQSw0QkFBNEIsRUFBNUJBLDRCQURhO0FBRWJoQyxFQUFBQSx1QkFBdUIsRUFBdkJBO0FBRmEsQyIsInNvdXJjZXNDb250ZW50IjpbInZhciBnZXRBbGxBdHRyaWJ1dGVzID0gZnVuY3Rpb24gKGVsZW1lbnQpIHtcbiAgdmFyIGF0dHJpYnV0ZURldGFpbHMgPSB7fTtcblxuICBpZiAoIWVsZW1lbnQuYXR0cmlidXRlcykge1xuICAgIHJldHVybiB7fTtcbiAgfVxuXG4gIHZhciBhdHRyaWJ1dGVzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoZWxlbWVudC5hdHRyaWJ1dGVzKTtcbiAgYXR0cmlidXRlcy5mb3JFYWNoKGZ1bmN0aW9uIChhdHRyaWJ1dGUpIHtcbiAgICBhdHRyaWJ1dGVEZXRhaWxzW2F0dHJpYnV0ZS5ub2RlTmFtZV0gPSBhdHRyaWJ1dGUubm9kZVZhbHVlO1xuICB9KTtcblxuICByZXR1cm4gYXR0cmlidXRlRGV0YWlscztcbn07XG5cbnZhciBjb25zdHJ1Y3RQYXJlbnRzQXJyYXkgPSBmdW5jdGlvbiAoZWxlbWVudCkge1xuICB2YXIgcGFyZW50QXJyYXkgPSBbXTtcbiAgdmFyIGluZGV4ID0gMDtcblxuICBpZiAoIWVsZW1lbnQucGFyZW50RWxlbWVudCkge1xuICAgIHJldHVybiBwYXJlbnRBcnJheTtcbiAgfVxuXG4gIGVsZW1lbnQgPSBlbGVtZW50LnBhcmVudEVsZW1lbnQ7XG5cbiAgd2hpbGUgKGVsZW1lbnQgIT09IG51bGwgJiYgaW5kZXggPCAxMCkge1xuICAgIGluZGV4ICs9IDE7XG4gICAgcGFyZW50QXJyYXkucHVzaChnZXREaXJlY3REZXRhaWxzKGVsZW1lbnQpKTtcblxuICAgIGVsZW1lbnQgPSBlbGVtZW50LnBhcmVudEVsZW1lbnQ7XG4gIH1cblxuICByZXR1cm4gcGFyZW50QXJyYXk7XG59O1xuXG52YXIgY29uc3RydWN0RGlyZWN0Q2hpbGRyZW5BcnJheSA9IGZ1bmN0aW9uIChlbGVtZW50KSB7XG4gIHZhciBjaGlsZHJlbkFycmF5ID0gW107XG5cbiAgaWYgKCFlbGVtZW50LmNoaWxkcmVuKSB7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICB2YXIgY2hpbGRyZW4gPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChlbGVtZW50LmNoaWxkcmVuKTtcblxuICBjaGlsZHJlbi5mb3JFYWNoKGZ1bmN0aW9uIChjaGlsZCkge1xuICAgIGNoaWxkcmVuQXJyYXkucHVzaCh7XG4gICAgICBkZXRhaWxzOiBnZXREaXJlY3REZXRhaWxzKGNoaWxkKSxcbiAgICAgIGNoaWxkcmVuOiBjb25zdHJ1Y3REaXJlY3RDaGlsZHJlbkFycmF5KGNoaWxkKSxcbiAgICB9KTtcbiAgfSk7XG5cbiAgcmV0dXJuIGNoaWxkcmVuQXJyYXk7XG59O1xuXG52YXIgY29uc3RydWN0RWxlbWVudERldGFpbHMgPSBmdW5jdGlvbiAoc2VsZWN0b3IsIHRlc3RMaW5lSXRlbUlkKSB7XG4gIHZhciBkb21FbGVtZW50ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihzZWxlY3Rvcik7XG5cbiAgaWYgKCFkb21FbGVtZW50IHx8ICF3aW5kb3cudHJ1ZG9uR2xvYmFscykge1xuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgdmFyIGVsZW1lbnREZXRhaWxzID0gZ2V0RGlyZWN0RGV0YWlscyhkb21FbGVtZW50KTtcbiAgaWYgKHRlc3RMaW5lSXRlbUlkKSB7XG4gICAgZWxlbWVudERldGFpbHMudGVzdExpbmVJdGVtSWQgPSB0ZXN0TGluZUl0ZW1JZDtcbiAgfVxuICBlbGVtZW50RGV0YWlscy5zZWxlY3RvciA9IHNlbGVjdG9yO1xuICBlbGVtZW50RGV0YWlscy5uZXh0U2libGluZyA9IGRvbUVsZW1lbnQubmV4dEVsZW1lbnRTaWJsaW5nID8gZ2V0RGlyZWN0RGV0YWlscyhkb21FbGVtZW50Lm5leHRFbGVtZW50U2libGluZykgOiBudWxsO1xuICBlbGVtZW50RGV0YWlscy5wcmV2aW91c1NpYmxpbmcgPSBkb21FbGVtZW50LnByZXZpb3VzRWxlbWVudFNpYmxpbmcgPyBnZXREaXJlY3REZXRhaWxzKGRvbUVsZW1lbnQucHJldmlvdXNFbGVtZW50U2libGluZykgOiBudWxsO1xuICBlbGVtZW50RGV0YWlscy5wYXJlbnRzID0gY29uc3RydWN0UGFyZW50c0FycmF5KGRvbUVsZW1lbnQpO1xuICBlbGVtZW50RGV0YWlscy5jaGlsZHJlbiA9IGNvbnN0cnVjdERpcmVjdENoaWxkcmVuQXJyYXkoZG9tRWxlbWVudCk7XG4gIGlmICh3aW5kb3cudHJ1ZG9uR2xvYmFscykge1xuICAgIGVsZW1lbnREZXRhaWxzLmN1cnJlbnRFbGVtZW50R3JhZGUgPSB3aW5kb3cudHJ1ZG9uR2xvYmFscy5zZWxlY3Rvck9wdGlvbnNIZWxwZXJzLmdldEZpbmFsR3JhZGVGb3JFbGVtZW50KGRvbUVsZW1lbnQsIGVsZW1lbnREZXRhaWxzKTtcbiAgfVxuXG4gIHJldHVybiBlbGVtZW50RGV0YWlscztcbn07XG5cbnZhciBnZXREaXJlY3REZXRhaWxzID0gZnVuY3Rpb24gKGVsZW1lbnQsIHdpdGhUZXh0Q29udGVudCA9IHRydWUpIHtcbiAgcmV0dXJuIHtcbiAgICB0YWc6IGVsZW1lbnQudGFnTmFtZSxcbiAgICB0ZXh0Q29udGVudDogd2l0aFRleHRDb250ZW50ICYmIGVsZW1lbnQudGV4dENvbnRlbnQgPyBlbGVtZW50LnRleHRDb250ZW50LnJlcGxhY2UoL1tcXG5cXHJcXHNdKy9nLCAnJykuc3Vic3RyaW5nKDAsIDEyOCkgOiBudWxsLCAvLyB0cmltIHRvIDEyOCBjaGFyYWN0ZXJzIGFuZCBkZWxldGUgd2hpdGUgc3BhY2VzIHRhYnMgYW5kIG5ldyBsaW5lc1xuICAgIG51bWJlck9mUHJldmlvdXNTaWJsaW5nczogZ2V0UHJldmlvdXNTaWJsaW5nc051bWJlcihlbGVtZW50KSxcbiAgICBudW1iZXJPZkFmdGVyU2libGluZ3M6IGdldE5leHRTaWJsaW5nc051bWJlcihlbGVtZW50KSxcbiAgICBhdHRyaWJ1dGVzOiBnZXRBbGxBdHRyaWJ1dGVzKGVsZW1lbnQpLFxuICB9O1xufTtcblxudmFyIGdldE5leHRTaWJsaW5nc051bWJlciA9IGZ1bmN0aW9uIChlbGVtZW50KSB7XG4gIHZhciBuZXh0U2libGluZ3MgPSAwO1xuXG4gIHdoaWxlIChlbGVtZW50Lm5leHRFbGVtZW50U2libGluZyAmJiBuZXh0U2libGluZ3MgPCAxMDApIHtcbiAgICBpZiAoZWxlbWVudC5ub2RlVHlwZSA9PT0gMykge1xuICAgICAgY29udGludWU7IC8vIHRleHQgbm9kZSBub3QgaW5jbHVkZWQgaW4gbmV4dEVsZW1lbnRTaWJsaW5nXG4gICAgfVxuICAgIGVsZW1lbnQgPSBlbGVtZW50Lm5leHRFbGVtZW50U2libGluZztcblxuICAgIG5leHRTaWJsaW5ncyArPSAxO1xuICB9XG5cbiAgcmV0dXJuIG5leHRTaWJsaW5ncztcbn07XG5cbnZhciBnZXRQcmV2aW91c1NpYmxpbmdzTnVtYmVyID0gZnVuY3Rpb24gKGVsZW1lbnQpIHtcbiAgdmFyIHByZXZpb3VzU2libGluZ3MgPSAwO1xuXG4gIHdoaWxlIChlbGVtZW50LnByZXZpb3VzRWxlbWVudFNpYmxpbmcgJiYgcHJldmlvdXNTaWJsaW5ncyA8IDEwMCkge1xuICAgIGlmIChlbGVtZW50Lm5vZGVUeXBlID09PSAzKSB7XG4gICAgICBjb250aW51ZTsgLy8gdGV4dCBub2RlIG5vdCBpbmNsdWRlZCBpbiBwcmV2aW91c0VsZW1lbnRTaWJsaW5nXG4gICAgfVxuICAgIGVsZW1lbnQgPSBlbGVtZW50LnByZXZpb3VzRWxlbWVudFNpYmxpbmc7XG5cbiAgICBwcmV2aW91c1NpYmxpbmdzICs9IDE7XG4gIH1cblxuICByZXR1cm4gcHJldmlvdXNTaWJsaW5ncztcbn07XG5cbnZhciBhZGRUb0dsb2JhbFZhcmlhYmxlID0gZnVuY3Rpb24gKHRlc3RMaW5lSXRlbURldGFpbHMpIHtcbiAgdmFyIGVsZW1lbnREZXRhaWxzID0gY29uc3RydWN0RWxlbWVudERldGFpbHModGVzdExpbmVJdGVtRGV0YWlscy5zZWxlY3RvciwgdGVzdExpbmVJdGVtRGV0YWlscy50ZXN0TGluZUl0ZW1JZCk7XG4gIGlmICh3aW5kb3cudHJ1ZG9uR2xvYmFscykge1xuICAgIHdpbmRvdy50cnVkb25HbG9iYWxzLmVsZW1lbnREZXRhaWxzLnB1c2goZWxlbWVudERldGFpbHMpO1xuICB9XG5cbiAgcmV0dXJuIGVsZW1lbnREZXRhaWxzO1xufTtcblxudmFyIGF0dGFjaEVsZW1lbnREZXRhaWxzVG9HbG9iYWwgPSAoKSA9PiB7XG4gIGlmICh3aW5kb3cudHJ1ZG9uR2xvYmFscykge1xuICAgIHJldHVybiBhZGRUb0dsb2JhbFZhcmlhYmxlKHdpbmRvdy50cnVkb25HbG9iYWxzLmVsZW1lbnQpO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IHtcbiAgYXR0YWNoRWxlbWVudERldGFpbHNUb0dsb2JhbCxcbiAgY29uc3RydWN0RWxlbWVudERldGFpbHMsXG59O1xuIl0sImZpbGUiOiJlbGVtZW50LWRldGFpbHMtaGVscGVyLmpzIn0=
