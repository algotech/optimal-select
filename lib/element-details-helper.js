"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var attachElementDetailsToGlobal = function attachElementDetailsToGlobal() {
  var returnConstructElementDetails = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : false;

  var getAllAttributes = function getAllAttributes(element) {
    var attributeDetails = {};

    if (!element.attributes) {
      return {};
    }

    var attributes = Array.prototype.slice.call(element.attributes);
    attributes.forEach(function (attribute) {
      attributeDetails[attribute.nodeName] = attribute.nodeValue;
    });
    return attributeDetails;
  };

  var constructParentsArray = function constructParentsArray(element) {
    var parentArray = [];
    var index = 0;

    if (!element.parentElement) {
      return parentArray;
    }

    element = element.parentElement;

    while (element !== null && index < 10) {
      index += 1;
      parentArray.push(getDirectDetails(element));
      element = element.parentElement;
    }

    return parentArray;
  };

  var constructDirectChildrenArray = function constructDirectChildrenArray(element) {
    var childrenArray = [];

    if (!element.children) {
      return null;
    }

    var children = Array.prototype.slice.call(element.children);
    children.forEach(function (child) {
      childrenArray.push({
        details: getDirectDetails(child),
        children: constructDirectChildrenArray(child)
      });
    });
    return childrenArray;
  };

  var constructElementDetails = function constructElementDetails(selector, testLineItemId) {
    var requestedByExtension = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : false;
    var domElement = document.querySelector(selector);

    if (!domElement || !window.trudonGlobals && !requestedByExtension) {
      return null;
    }

    var elementDetails = getDirectDetails(domElement);

    if (testLineItemId) {
      elementDetails.testLineItemId = testLineItemId;
    }

    elementDetails.selector = selector;
    elementDetails.nextSibling = domElement.nextElementSibling ? getDirectDetails(domElement.nextElementSibling) : null;
    elementDetails.previousSibling = domElement.previousElementSibling ? getDirectDetails(domElement.previousElementSibling) : null;
    elementDetails.parents = constructParentsArray(domElement);
    elementDetails.children = constructDirectChildrenArray(domElement);

    if (window.trudonGlobals) {
      elementDetails.currentElementGrade = window.trudonGlobals.selectorOptionsHelpers.getFinalGradeForElement(domElement, elementDetails);
    }

    return elementDetails;
  };

  var getDirectDetails = function getDirectDetails(element) {
    var withTextContent = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : true;
    return {
      tag: element.tagName,
      textContent: withTextContent && element.textContent ? element.textContent.replace(/[\n\r\s]+/g, '').substring(0, 128) : null,
      // trim to 128 characters and delete white spaces tabs and new lines
      numberOfPreviousSiblings: getPreviousSiblingsNumber(element),
      numberOfAfterSiblings: getNextSiblingsNumber(element),
      attributes: getAllAttributes(element)
    };
  };

  var getNextSiblingsNumber = function getNextSiblingsNumber(element) {
    var nextSiblings = 0;

    while (element.nextElementSibling && nextSiblings < 100) {
      if (element.nodeType === 3) {
        continue; // text node not included in nextElementSibling
      }

      element = element.nextElementSibling;
      nextSiblings += 1;
    }

    return nextSiblings;
  };

  var getPreviousSiblingsNumber = function getPreviousSiblingsNumber(element) {
    var previousSiblings = 0;

    while (element.previousElementSibling && previousSiblings < 100) {
      if (element.nodeType === 3) {
        continue; // text node not included in previousElementSibling
      }

      element = element.previousElementSibling;
      previousSiblings += 1;
    }

    return previousSiblings;
  };

  var addToGlobalVariable = function addToGlobalVariable(testLineItemDetails) {
    var elementDetails = constructElementDetails(testLineItemDetails.selector, testLineItemDetails.testLineItemId);

    if (window.trudonGlobals) {
      window.trudonGlobals.elementDetails.push(elementDetails);
    }

    return elementDetails;
  };

  if (returnConstructElementDetails) {
    return constructElementDetails;
  }

  if (window.trudonGlobals) {
    return addToGlobalVariable(window.trudonGlobals.element);
  }
};

var _default = {
  attachElementDetailsToGlobal: attachElementDetailsToGlobal,
  constructElementDetails: attachElementDetailsToGlobal(true)
};
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImVsZW1lbnQtZGV0YWlscy1oZWxwZXIuanMiXSwibmFtZXMiOlsiYXR0YWNoRWxlbWVudERldGFpbHNUb0dsb2JhbCIsInJldHVybkNvbnN0cnVjdEVsZW1lbnREZXRhaWxzIiwiZ2V0QWxsQXR0cmlidXRlcyIsImVsZW1lbnQiLCJhdHRyaWJ1dGVEZXRhaWxzIiwiYXR0cmlidXRlcyIsIkFycmF5IiwicHJvdG90eXBlIiwic2xpY2UiLCJjYWxsIiwiZm9yRWFjaCIsImF0dHJpYnV0ZSIsIm5vZGVOYW1lIiwibm9kZVZhbHVlIiwiY29uc3RydWN0UGFyZW50c0FycmF5IiwicGFyZW50QXJyYXkiLCJpbmRleCIsInBhcmVudEVsZW1lbnQiLCJwdXNoIiwiZ2V0RGlyZWN0RGV0YWlscyIsImNvbnN0cnVjdERpcmVjdENoaWxkcmVuQXJyYXkiLCJjaGlsZHJlbkFycmF5IiwiY2hpbGRyZW4iLCJjaGlsZCIsImRldGFpbHMiLCJjb25zdHJ1Y3RFbGVtZW50RGV0YWlscyIsInNlbGVjdG9yIiwidGVzdExpbmVJdGVtSWQiLCJyZXF1ZXN0ZWRCeUV4dGVuc2lvbiIsImRvbUVsZW1lbnQiLCJkb2N1bWVudCIsInF1ZXJ5U2VsZWN0b3IiLCJ3aW5kb3ciLCJ0cnVkb25HbG9iYWxzIiwiZWxlbWVudERldGFpbHMiLCJuZXh0U2libGluZyIsIm5leHRFbGVtZW50U2libGluZyIsInByZXZpb3VzU2libGluZyIsInByZXZpb3VzRWxlbWVudFNpYmxpbmciLCJwYXJlbnRzIiwiY3VycmVudEVsZW1lbnRHcmFkZSIsInNlbGVjdG9yT3B0aW9uc0hlbHBlcnMiLCJnZXRGaW5hbEdyYWRlRm9yRWxlbWVudCIsIndpdGhUZXh0Q29udGVudCIsInRhZyIsInRhZ05hbWUiLCJ0ZXh0Q29udGVudCIsInJlcGxhY2UiLCJzdWJzdHJpbmciLCJudW1iZXJPZlByZXZpb3VzU2libGluZ3MiLCJnZXRQcmV2aW91c1NpYmxpbmdzTnVtYmVyIiwibnVtYmVyT2ZBZnRlclNpYmxpbmdzIiwiZ2V0TmV4dFNpYmxpbmdzTnVtYmVyIiwibmV4dFNpYmxpbmdzIiwibm9kZVR5cGUiLCJwcmV2aW91c1NpYmxpbmdzIiwiYWRkVG9HbG9iYWxWYXJpYWJsZSIsInRlc3RMaW5lSXRlbURldGFpbHMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQSxJQUFJQSw0QkFBNEIsR0FBRyxTQUEvQkEsNEJBQStCLEdBQTJDO0FBQUEsTUFBMUNDLDZCQUEwQyx1RUFBVixLQUFVOztBQUM1RSxNQUFJQyxnQkFBZ0IsR0FBRyxTQUFuQkEsZ0JBQW1CLENBQVVDLE9BQVYsRUFBbUI7QUFDeEMsUUFBSUMsZ0JBQWdCLEdBQUcsRUFBdkI7O0FBRUEsUUFBSSxDQUFDRCxPQUFPLENBQUNFLFVBQWIsRUFBeUI7QUFDdkIsYUFBTyxFQUFQO0FBQ0Q7O0FBRUQsUUFBSUEsVUFBVSxHQUFHQyxLQUFLLENBQUNDLFNBQU4sQ0FBZ0JDLEtBQWhCLENBQXNCQyxJQUF0QixDQUEyQk4sT0FBTyxDQUFDRSxVQUFuQyxDQUFqQjtBQUNBQSxJQUFBQSxVQUFVLENBQUNLLE9BQVgsQ0FBbUIsVUFBVUMsU0FBVixFQUFxQjtBQUN0Q1AsTUFBQUEsZ0JBQWdCLENBQUNPLFNBQVMsQ0FBQ0MsUUFBWCxDQUFoQixHQUF1Q0QsU0FBUyxDQUFDRSxTQUFqRDtBQUNELEtBRkQ7QUFJQSxXQUFPVCxnQkFBUDtBQUNELEdBYkQ7O0FBZUEsTUFBSVUscUJBQXFCLEdBQUcsU0FBeEJBLHFCQUF3QixDQUFVWCxPQUFWLEVBQW1CO0FBQzdDLFFBQUlZLFdBQVcsR0FBRyxFQUFsQjtBQUNBLFFBQUlDLEtBQUssR0FBRyxDQUFaOztBQUVBLFFBQUksQ0FBQ2IsT0FBTyxDQUFDYyxhQUFiLEVBQTRCO0FBQzFCLGFBQU9GLFdBQVA7QUFDRDs7QUFFRFosSUFBQUEsT0FBTyxHQUFHQSxPQUFPLENBQUNjLGFBQWxCOztBQUVBLFdBQU9kLE9BQU8sS0FBSyxJQUFaLElBQW9CYSxLQUFLLEdBQUcsRUFBbkMsRUFBdUM7QUFDckNBLE1BQUFBLEtBQUssSUFBSSxDQUFU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Q0FBVUMsbUJBQVYsRUFBK0I7QUFDdkQsUUFBSXZCLGNBQWMsR0FBR1QsdUJBQXVCLENBQUNnQyxtQkFBbUIsQ0FBQy9CLFFBQXJCLEVBQStCK0IsbUJBQW1CLENBQUM5QixjQUFuRCxDQUE1Qzs7QUFDQSxRQUFJSyxNQUFNLENBQUNDLGFBQVgsRUFBMEI7QUFDeEJELE1BQUFBLE1BQU0sQ0FBQ0MsYUFBUCxDQUFxQkMsY0FBckIsQ0FBb0NoQixJQUFwQyxDQUF5Q2dCLGNBQXpDO0FBQ0Q7O0FBRUQsV0FBT0EsY0FBUDtBQUNELEdBUEQ7O0FBU0EsTUFBSWpDLDZCQUFKLEVBQW1DO0FBQ2pDLFdBQU93Qix1QkFBUDtBQUNEOztBQUNELE1BQUlPLE1BQU0sQ0FBQ0MsYUFBWCxFQUEwQjtBQUN4QixXQUFPdUIsbUJBQW1CLENBQUN4QixNQUFNLENBQUNDLGFBQVAsQ0FBcUI5QixPQUF0QixDQUExQjtBQUNEO0FBQ0YsQ0FySUQ7O2VBdUllO0FBQ2JILEVBQUFBLDRCQUE0QixFQUE1QkEsNEJBRGE7QUFFYnlCLEVBQUFBLHVCQUF1QixFQUFFekIsNEJBQTRCLENBQUMsSUFBRDtBQUZ4QyxDIiwic291cmNlc0NvbnRlbnQiOlsidmFyIGF0dGFjaEVsZW1lbnREZXRhaWxzVG9HbG9iYWwgPSAocmV0dXJuQ29uc3RydWN0RWxlbWVudERldGFpbHMgPSBmYWxzZSkgPT4ge1xuICB2YXIgZ2V0QWxsQXR0cmlidXRlcyA9IGZ1bmN0aW9uIChlbGVtZW50KSB7XG4gICAgdmFyIGF0dHJpYnV0ZURldGFpbHMgPSB7fTtcblxuICAgIGlmICghZWxlbWVudC5hdHRyaWJ1dGVzKSB7XG4gICAgICByZXR1cm4ge307XG4gICAgfVxuXG4gICAgdmFyIGF0dHJpYnV0ZXMgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChlbGVtZW50LmF0dHJpYnV0ZXMpO1xuICAgIGF0dHJpYnV0ZXMuZm9yRWFjaChmdW5jdGlvbiAoYXR0cmlidXRlKSB7XG4gICAgICBhdHRyaWJ1dGVEZXRhaWxzW2F0dHJpYnV0ZS5ub2RlTmFtZV0gPSBhdHRyaWJ1dGUubm9kZVZhbHVlO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIGF0dHJpYnV0ZURldGFpbHM7XG4gIH07XG5cbiAgdmFyIGNvbnN0cnVjdFBhcmVudHNBcnJheSA9IGZ1bmN0aW9uIChlbGVtZW50KSB7XG4gICAgdmFyIHBhcmVudEFycmF5ID0gW107XG4gICAgdmFyIGluZGV4ID0gMDtcblxuICAgIGlmICghZWxlbWVudC5wYXJlbnRFbGVtZW50KSB7XG4gICAgICByZXR1cm4gcGFyZW50QXJyYXk7XG4gICAgfVxuXG4gICAgZWxlbWVudCA9IGVsZW1lbnQucGFyZW50RWxlbWVudDtcblxuICAgIHdoaWxlIChlbGVtZW50ICE9PSBudWxsICYmIGluZGV4IDwgMTApIHtcbiAgICAgIGluZGV4ICs9IDE7XG4gICAgICBwYXJlbnRBcnJheS5wdXNoKGdldERpcmVjdERldGFpbHMoZWxlbWVudCkpO1xuXG4gICAgICBlbGVtZW50ID0gZWxlbWVudC5wYXJlbnRFbGVtZW50O1xuICAgIH1cblxuICAgIHJldHVybiBwYXJlbnRBcnJheTtcbiAgfTtcblxuICB2YXIgY29uc3RydWN0RGlyZWN0Q2hpbGRyZW5BcnJheSA9IGZ1bmN0aW9uIChlbGVtZW50KSB7XG4gICAgdmFyIGNoaWxkcmVuQXJyYXkgPSBbXTtcblxuICAgIGlmICghZWxlbWVudC5jaGlsZHJlbikge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgdmFyIGNoaWxkcmVuID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoZWxlbWVudC5jaGlsZHJlbik7XG5cbiAgICBjaGlsZHJlbi5mb3JFYWNoKGZ1bmN0aW9uIChjaGlsZCkge1xuICAgICAgY2hpbGRyZW5BcnJheS5wdXNoKHtcbiAgICAgICAgZGV0YWlsczogZ2V0RGlyZWN0RGV0YWlscyhjaGlsZCksXG4gICAgICAgIGNoaWxkcmVuOiBjb25zdHJ1Y3REaXJlY3RDaGlsZHJlbkFycmF5KGNoaWxkKSxcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIGNoaWxkcmVuQXJyYXk7XG4gIH07XG5cbiAgdmFyIGNvbnN0cnVjdEVsZW1lbnREZXRhaWxzID0gZnVuY3Rpb24gKHNlbGVjdG9yLCB0ZXN0TGluZUl0ZW1JZCwgcmVxdWVzdGVkQnlFeHRlbnNpb24gPSBmYWxzZSkge1xuICAgIHZhciBkb21FbGVtZW50ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihzZWxlY3Rvcik7XG5cbiAgICBpZiAoIWRvbUVsZW1lbnQgfHwgKCF3aW5kb3cudHJ1ZG9uR2xvYmFscyAmJiAhcmVxdWVzdGVkQnlFeHRlbnNpb24pKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICB2YXIgZWxlbWVudERldGFpbHMgPSBnZXREaXJlY3REZXRhaWxzKGRvbUVsZW1lbnQpO1xuICAgIGlmICh0ZXN0TGluZUl0ZW1JZCkge1xuICAgICAgZWxlbWVudERldGFpbHMudGVzdExpbmVJdGVtSWQgPSB0ZXN0TGluZUl0ZW1JZDtcbiAgICB9XG4gICAgZWxlbWVudERldGFpbHMuc2VsZWN0b3IgPSBzZWxlY3RvcjtcbiAgICBlbGVtZW50RGV0YWlscy5uZXh0U2libGluZyA9IGRvbUVsZW1lbnQubmV4dEVsZW1lbnRTaWJsaW5nID8gZ2V0RGlyZWN0RGV0YWlscyhkb21FbGVtZW50Lm5leHRFbGVtZW50U2libGluZykgOiBudWxsO1xuICAgIGVsZW1lbnREZXRhaWxzLnByZXZpb3VzU2libGluZyA9IGRvbUVsZW1lbnQucHJldmlvdXNFbGVtZW50U2libGluZyA/IGdldERpcmVjdERldGFpbHMoZG9tRWxlbWVudC5wcmV2aW91c0VsZW1lbnRTaWJsaW5nKSA6IG51bGw7XG4gICAgZWxlbWVudERldGFpbHMucGFyZW50cyA9IGNvbnN0cnVjdFBhcmVudHNBcnJheShkb21FbGVtZW50KTtcbiAgICBlbGVtZW50RGV0YWlscy5jaGlsZHJlbiA9IGNvbnN0cnVjdERpcmVjdENoaWxkcmVuQXJyYXkoZG9tRWxlbWVudCk7XG4gICAgaWYgKHdpbmRvdy50cnVkb25HbG9iYWxzKSB7XG4gICAgICBlbGVtZW50RGV0YWlscy5jdXJyZW50RWxlbWVudEdyYWRlID0gd2luZG93LnRydWRvbkdsb2JhbHMuc2VsZWN0b3JPcHRpb25zSGVscGVycy5nZXRGaW5hbEdyYWRlRm9yRWxlbWVudChkb21FbGVtZW50LCBlbGVtZW50RGV0YWlscyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGVsZW1lbnREZXRhaWxzO1xuICB9O1xuXG4gIHZhciBnZXREaXJlY3REZXRhaWxzID0gZnVuY3Rpb24gKGVsZW1lbnQsIHdpdGhUZXh0Q29udGVudCA9IHRydWUpIHtcbiAgICByZXR1cm4ge1xuICAgICAgdGFnOiBlbGVtZW50LnRhZ05hbWUsXG4gICAgICB0ZXh0Q29udGVudDogd2l0aFRleHRDb250ZW50ICYmIGVsZW1lbnQudGV4dENvbnRlbnQgPyBlbGVtZW50LnRleHRDb250ZW50LnJlcGxhY2UoL1tcXG5cXHJcXHNdKy9nLCAnJykuc3Vic3RyaW5nKDAsIDEyOCkgOiBudWxsLCAvLyB0cmltIHRvIDEyOCBjaGFyYWN0ZXJzIGFuZCBkZWxldGUgd2hpdGUgc3BhY2VzIHRhYnMgYW5kIG5ldyBsaW5lc1xuICAgICAgbnVtYmVyT2ZQcmV2aW91c1NpYmxpbmdzOiBnZXRQcmV2aW91c1NpYmxpbmdzTnVtYmVyKGVsZW1lbnQpLFxuICAgICAgbnVtYmVyT2ZBZnRlclNpYmxpbmdzOiBnZXROZXh0U2libGluZ3NOdW1iZXIoZWxlbWVudCksXG4gICAgICBhdHRyaWJ1dGVzOiBnZXRBbGxBdHRyaWJ1dGVzKGVsZW1lbnQpLFxuICAgIH07XG4gIH07XG5cbiAgdmFyIGdldE5leHRTaWJsaW5nc051bWJlciA9IGZ1bmN0aW9uIChlbGVtZW50KSB7XG4gICAgdmFyIG5leHRTaWJsaW5ncyA9IDA7XG5cbiAgICB3aGlsZSAoZWxlbWVudC5uZXh0RWxlbWVudFNpYmxpbmcgJiYgbmV4dFNpYmxpbmdzIDwgMTAwKSB7XG4gICAgICBpZiAoZWxlbWVudC5ub2RlVHlwZSA9PT0gMykge1xuICAgICAgICBjb250aW51ZTsgLy8gdGV4dCBub2RlIG5vdCBpbmNsdWRlZCBpbiBuZXh0RWxlbWVudFNpYmxpbmdcbiAgICAgIH1cbiAgICAgIGVsZW1lbnQgPSBlbGVtZW50Lm5leHRFbGVtZW50U2libGluZztcblxuICAgICAgbmV4dFNpYmxpbmdzICs9IDE7XG4gICAgfVxuXG4gICAgcmV0dXJuIG5leHRTaWJsaW5ncztcbiAgfTtcblxuICB2YXIgZ2V0UHJldmlvdXNTaWJsaW5nc051bWJlciA9IGZ1bmN0aW9uIChlbGVtZW50KSB7XG4gICAgdmFyIHByZXZpb3VzU2libGluZ3MgPSAwO1xuXG4gICAgd2hpbGUgKGVsZW1lbnQucHJldmlvdXNFbGVtZW50U2libGluZyAmJiBwcmV2aW91c1NpYmxpbmdzIDwgMTAwKSB7XG4gICAgICBpZiAoZWxlbWVudC5ub2RlVHlwZSA9PT0gMykge1xuICAgICAgICBjb250aW51ZTsgLy8gdGV4dCBub2RlIG5vdCBpbmNsdWRlZCBpbiBwcmV2aW91c0VsZW1lbnRTaWJsaW5nXG4gICAgICB9XG4gICAgICBlbGVtZW50ID0gZWxlbWVudC5wcmV2aW91c0VsZW1lbnRTaWJsaW5nO1xuXG4gICAgICBwcmV2aW91c1NpYmxpbmdzICs9IDE7XG4gICAgfVxuXG4gICAgcmV0dXJuIHByZXZpb3VzU2libGluZ3M7XG4gIH07XG5cbiAgdmFyIGFkZFRvR2xvYmFsVmFyaWFibGUgPSBmdW5jdGlvbiAodGVzdExpbmVJdGVtRGV0YWlscykge1xuICAgIHZhciBlbGVtZW50RGV0YWlscyA9IGNvbnN0cnVjdEVsZW1lbnREZXRhaWxzKHRlc3RMaW5lSXRlbURldGFpbHMuc2VsZWN0b3IsIHRlc3RMaW5lSXRlbURldGFpbHMudGVzdExpbmVJdGVtSWQpO1xuICAgIGlmICh3aW5kb3cudHJ1ZG9uR2xvYmFscykge1xuICAgICAgd2luZG93LnRydWRvbkdsb2JhbHMuZWxlbWVudERldGFpbHMucHVzaChlbGVtZW50RGV0YWlscyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGVsZW1lbnREZXRhaWxzO1xuICB9O1xuXG4gIGlmIChyZXR1cm5Db25zdHJ1Y3RFbGVtZW50RGV0YWlscykge1xuICAgIHJldHVybiBjb25zdHJ1Y3RFbGVtZW50RGV0YWlscztcbiAgfVxuICBpZiAod2luZG93LnRydWRvbkdsb2JhbHMpIHtcbiAgICByZXR1cm4gYWRkVG9HbG9iYWxWYXJpYWJsZSh3aW5kb3cudHJ1ZG9uR2xvYmFscy5lbGVtZW50KTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCB7XG4gIGF0dGFjaEVsZW1lbnREZXRhaWxzVG9HbG9iYWwsXG4gIGNvbnN0cnVjdEVsZW1lbnREZXRhaWxzOiBhdHRhY2hFbGVtZW50RGV0YWlsc1RvR2xvYmFsKHRydWUpLFxufTtcbiJdLCJmaWxlIjoiZWxlbWVudC1kZXRhaWxzLWhlbHBlci5qcyJ9
