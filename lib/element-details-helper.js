"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var getAllAttributes = function getAllAttributes(element) {
  var attributeDetails = {};

  if (!element.attributes) {
    return {};
  }

  var attributes = Array.prototype.slice.call(element.attributes);
  attributes.forEach(function (attribute) {
    attributeDetails[attribute.nodeName] = attribute.nodeValue;
  });
  return attributeDetails;
};

var constructParentsArray = function constructParentsArray(element) {
  var parentArray = [];
  var index = 0;

  if (!element.parentElement) {
    return parentArray;
  }

  element = element.parentElement;

  while (element !== null && index < 10) {
    index += 1;
    parentArray.push(getDirectDetails(element));
    element = element.parentElement;
  }

  return parentArray;
};

var constructDirectChildrenArray = function constructDirectChildrenArray(element) {
  var childrenArray = [];

  if (!element.children) {
    return null;
  }

  var children = Array.prototype.slice.call(element.children);
  children.forEach(function (child) {
    childrenArray.push({
      details: getDirectDetails(child),
      children: constructDirectChildrenArray(child)
    });
  });
  return childrenArray;
};

var constructElementDetail = function constructElementDetail(selector, testLineItemId) {
  var domElement = document.querySelector(selector);

  if (!domElement || !window.trudonGlobals) {
    return null;
  }

  var elementDetails = getDirectDetails(domElement);

  if (testLineItemId) {
    elementDetails.testLineItemId = testLineItemId;
  }

  elementDetails.selector = selector;
  elementDetails.nextSibling = domElement.nextElementSibling ? getDirectDetails(domElement.nextElementSibling) : null;
  elementDetails.previousSibling = domElement.previousElementSibling ? getDirectDetails(domElement.previousElementSibling) : null;
  elementDetails.parents = constructParentsArray(domElement);
  elementDetails.children = constructDirectChildrenArray(domElement);

  if (window.trudonGlobals) {
    elementDetails.currentElementGrade = window.trudonGlobals.selectorOptionsHelpers.getFinalGradeForElement(domElement, elementDetails);
  }

  return elementDetails;
};

var getDirectDetails = function getDirectDetails(element) {
  var withTextContent = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : true;
  return {
    tag: element.tagName,
    textContent: withTextContent && element.textContent ? element.textContent.replace(/[\n\r\s]+/g, '').substring(0, 128) : null,
    // trim to 128 characters and delete white spaces tabs and new lines
    numberOfPreviousSiblings: getPreviousSiblingsNumber(element),
    numberOfAfterSiblings: getNextSiblingsNumber(element),
    attributes: getAllAttributes(element)
  };
};

var getNextSiblingsNumber = function getNextSiblingsNumber(element) {
  var nextSiblings = 0;

  while (element.nextElementSibling && nextSiblings < 100) {
    if (element.nodeType === 3) {
      continue; // text node not included in nextElementSibling
    }

    element = element.nextElementSibling;
    nextSiblings += 1;
  }

  return nextSiblings;
};

var getPreviousSiblingsNumber = function getPreviousSiblingsNumber(element) {
  var previousSiblings = 0;

  while (element.previousElementSibling && previousSiblings < 100) {
    if (element.nodeType === 3) {
      continue; // text node not included in previousElementSibling
    }

    element = element.previousElementSibling;
    previousSiblings += 1;
  }

  return previousSiblings;
};

var addToGlobalVariable = function addToGlobalVariable(testLineItemDetails) {
  var elementDetails = constructElementDetail(testLineItemDetails.selector, testLineItemDetails.testLineItemId);

  if (window.trudonGlobals) {
    window.trudonGlobals.elementDetails.push(elementDetails);
  }

  return elementDetails;
};

var attachElementDetailsToGlobal = function attachElementDetailsToGlobal() {
  if (window.trudonGlobals) {
    return addToGlobalVariable(window.trudonGlobals.element);
  }
};

var _default = {
  attachElementDetailsToGlobal: attachElementDetailsToGlobal,
  constructElementDetail: constructElementDetail
};
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImVsZW1lbnQtZGV0YWlscy1oZWxwZXIuanMiXSwibmFtZXMiOlsiZ2V0QWxsQXR0cmlidXRlcyIsImVsZW1lbnQiLCJhdHRyaWJ1dGVEZXRhaWxzIiwiYXR0cmlidXRlcyIsIkFycmF5IiwicHJvdG90eXBlIiwic2xpY2UiLCJjYWxsIiwiZm9yRWFjaCIsImF0dHJpYnV0ZSIsIm5vZGVOYW1lIiwibm9kZVZhbHVlIiwiY29uc3RydWN0UGFyZW50c0FycmF5IiwicGFyZW50QXJyYXkiLCJpbmRleCIsInBhcmVudEVsZW1lbnQiLCJwdXNoIiwiZ2V0RGlyZWN0RGV0YWlscyIsImNvbnN0cnVjdERpcmVjdENoaWxkcmVuQXJyYXkiLCJjaGlsZHJlbkFycmF5IiwiY2hpbGRyZW4iLCJjaGlsZCIsImRldGFpbHMiLCJjb25zdHJ1Y3RFbGVtZW50RGV0YWlsIiwic2VsZWN0b3IiLCJ0ZXN0TGluZUl0ZW1JZCIsImRvbUVsZW1lbnQiLCJkb2N1bWVudCIsInF1ZXJ5U2VsZWN0b3IiLCJ3aW5kb3ciLCJ0cnVkb25HbG9iYWxzIiwiZWxlbWVudERldGFpbHMiLCJuZXh0U2libGluZyIsIm5leHRFbGVtZW50U2libGluZyIsInByZXZpb3VzU2libGluZyIsInByZXZpb3VzRWxlbWVudFNpYmxpbmciLCJwYXJlbnRzIiwiY3VycmVudEVsZW1lbnRHcmFkZSIsInNlbGVjdG9yT3B0aW9uc0hlbHBlcnMiLCJnZXRGaW5hbEdyYWRlRm9yRWxlbWVudCIsIndpdGhUZXh0Q29udGVudCIsInRhZyIsInRhZ05hbWUiLCJ0ZXh0Q29udGVudCIsInJlcGxhY2UiLCJzdWJzdHJpbmciLCJudW1iZXJPZlByZXZpb3VzU2libGluZ3MiLCJnZXRQcmV2aW91c1NpYmxpbmdzTnVtYmVyIiwibnVtYmVyT2ZBZnRlclNpYmxpbmdzIiwiZ2V0TmV4dFNpYmxpbmdzTnVtYmVyIiwibmV4dFNpYmxpbmdzIiwibm9kZVR5cGUiLCJwcmV2aW91c1NpYmxpbmdzIiwiYWRkVG9HbG9iYWxWYXJpYWJs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QXJCLENBQW9DZixJQUFwQyxDQUF5Q2UsY0FBekM7QUFDRDs7QUFFRCxTQUFPQSxjQUFQO0FBQ0QsQ0FQRDs7QUFTQSxJQUFJd0IsNEJBQTRCLEdBQUcsU0FBL0JBLDRCQUErQixHQUFNO0FBQ3ZDLE1BQUkxQixNQUFNLENBQUNDLGFBQVgsRUFBMEI7QUFDeEIsV0FBT3VCLG1CQUFtQixDQUFDeEIsTUFBTSxDQUFDQyxhQUFQLENBQXFCN0IsT0FBdEIsQ0FBMUI7QUFDRDtBQUNGLENBSkQ7O2VBTWU7QUFDYnNELEVBQUFBLDRCQUE0QixFQUE1QkEsNEJBRGE7QUFFYmhDLEVBQUFBLHNCQUFzQixFQUF0QkE7QUFGYSxDIiwic291cmNlc0NvbnRlbnQiOlsidmFyIGdldEFsbEF0dHJpYnV0ZXMgPSBmdW5jdGlvbiAoZWxlbWVudCkge1xuICB2YXIgYXR0cmlidXRlRGV0YWlscyA9IHt9O1xuXG4gIGlmICghZWxlbWVudC5hdHRyaWJ1dGVzKSB7XG4gICAgcmV0dXJuIHt9O1xuICB9XG5cbiAgdmFyIGF0dHJpYnV0ZXMgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChlbGVtZW50LmF0dHJpYnV0ZXMpO1xuICBhdHRyaWJ1dGVzLmZvckVhY2goZnVuY3Rpb24gKGF0dHJpYnV0ZSkge1xuICAgIGF0dHJpYnV0ZURldGFpbHNbYXR0cmlidXRlLm5vZGVOYW1lXSA9IGF0dHJpYnV0ZS5ub2RlVmFsdWU7XG4gIH0pO1xuXG4gIHJldHVybiBhdHRyaWJ1dGVEZXRhaWxzO1xufTtcblxudmFyIGNvbnN0cnVjdFBhcmVudHNBcnJheSA9IGZ1bmN0aW9uIChlbGVtZW50KSB7XG4gIHZhciBwYXJlbnRBcnJheSA9IFtdO1xuICB2YXIgaW5kZXggPSAwO1xuXG4gIGlmICghZWxlbWVudC5wYXJlbnRFbGVtZW50KSB7XG4gICAgcmV0dXJuIHBhcmVudEFycmF5O1xuICB9XG5cbiAgZWxlbWVudCA9IGVsZW1lbnQucGFyZW50RWxlbWVudDtcblxuICB3aGlsZSAoZWxlbWVudCAhPT0gbnVsbCAmJiBpbmRleCA8IDEwKSB7XG4gICAgaW5kZXggKz0gMTtcbiAgICBwYXJlbnRBcnJheS5wdXNoKGdldERpcmVjdERldGFpbHMoZWxlbWVudCkpO1xuXG4gICAgZWxlbWVudCA9IGVsZW1lbnQucGFyZW50RWxlbWVudDtcbiAgfVxuXG4gIHJldHVybiBwYXJlbnRBcnJheTtcbn07XG5cbnZhciBjb25zdHJ1Y3REaXJlY3RDaGlsZHJlbkFycmF5ID0gZnVuY3Rpb24gKGVsZW1lbnQpIHtcbiAgdmFyIGNoaWxkcmVuQXJyYXkgPSBbXTtcblxuICBpZiAoIWVsZW1lbnQuY2hpbGRyZW4pIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIHZhciBjaGlsZHJlbiA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGVsZW1lbnQuY2hpbGRyZW4pO1xuXG4gIGNoaWxkcmVuLmZvckVhY2goZnVuY3Rpb24gKGNoaWxkKSB7XG4gICAgY2hpbGRyZW5BcnJheS5wdXNoKHtcbiAgICAgIGRldGFpbHM6IGdldERpcmVjdERldGFpbHMoY2hpbGQpLFxuICAgICAgY2hpbGRyZW46IGNvbnN0cnVjdERpcmVjdENoaWxkcmVuQXJyYXkoY2hpbGQpLFxuICAgIH0pO1xuICB9KTtcblxuICByZXR1cm4gY2hpbGRyZW5BcnJheTtcbn07XG5cbnZhciBjb25zdHJ1Y3RFbGVtZW50RGV0YWlsID0gZnVuY3Rpb24gKHNlbGVjdG9yLCB0ZXN0TGluZUl0ZW1JZCkge1xuICB2YXIgZG9tRWxlbWVudCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3Ioc2VsZWN0b3IpO1xuXG4gIGlmICghZG9tRWxlbWVudCB8fCAhd2luZG93LnRydWRvbkdsb2JhbHMpIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIHZhciBlbGVtZW50RGV0YWlscyA9IGdldERpcmVjdERldGFpbHMoZG9tRWxlbWVudCk7XG4gIGlmICh0ZXN0TGluZUl0ZW1JZCkge1xuICAgIGVsZW1lbnREZXRhaWxzLnRlc3RMaW5lSXRlbUlkID0gdGVzdExpbmVJdGVtSWQ7XG4gIH1cbiAgZWxlbWVudERldGFpbHMuc2VsZWN0b3IgPSBzZWxlY3RvcjtcbiAgZWxlbWVudERldGFpbHMubmV4dFNpYmxpbmcgPSBkb21FbGVtZW50Lm5leHRFbGVtZW50U2libGluZyA/IGdldERpcmVjdERldGFpbHMoZG9tRWxlbWVudC5uZXh0RWxlbWVudFNpYmxpbmcpIDogbnVsbDtcbiAgZWxlbWVudERldGFpbHMucHJldmlvdXNTaWJsaW5nID0gZG9tRWxlbWVudC5wcmV2aW91c0VsZW1lbnRTaWJsaW5nID8gZ2V0RGlyZWN0RGV0YWlscyhkb21FbGVtZW50LnByZXZpb3VzRWxlbWVudFNpYmxpbmcpIDogbnVsbDtcbiAgZWxlbWVudERldGFpbHMucGFyZW50cyA9IGNvbnN0cnVjdFBhcmVudHNBcnJheShkb21FbGVtZW50KTtcbiAgZWxlbWVudERldGFpbHMuY2hpbGRyZW4gPSBjb25zdHJ1Y3REaXJlY3RDaGlsZHJlbkFycmF5KGRvbUVsZW1lbnQpO1xuICBpZiAod2luZG93LnRydWRvbkdsb2JhbHMpIHtcbiAgICBlbGVtZW50RGV0YWlscy5jdXJyZW50RWxlbWVudEdyYWRlID0gd2luZG93LnRydWRvbkdsb2JhbHMuc2VsZWN0b3JPcHRpb25zSGVscGVycy5nZXRGaW5hbEdyYWRlRm9yRWxlbWVudChkb21FbGVtZW50LCBlbGVtZW50RGV0YWlscyk7XG4gIH1cblxuICByZXR1cm4gZWxlbWVudERldGFpbHM7XG59O1xuXG52YXIgZ2V0RGlyZWN0RGV0YWlscyA9IGZ1bmN0aW9uIChlbGVtZW50LCB3aXRoVGV4dENvbnRlbnQgPSB0cnVlKSB7XG4gIHJldHVybiB7XG4gICAgdGFnOiBlbGVtZW50LnRhZ05hbWUsXG4gICAgdGV4dENvbnRlbnQ6IHdpdGhUZXh0Q29udGVudCAmJiBlbGVtZW50LnRleHRDb250ZW50ID8gZWxlbWVudC50ZXh0Q29udGVudC5yZXBsYWNlKC9bXFxuXFxyXFxzXSsvZywgJycpLnN1YnN0cmluZygwLCAxMjgpIDogbnVsbCwgLy8gdHJpbSB0byAxMjggY2hhcmFjdGVycyBhbmQgZGVsZXRlIHdoaXRlIHNwYWNlcyB0YWJzIGFuZCBuZXcgbGluZXNcbiAgICBudW1iZXJPZlByZXZpb3VzU2libGluZ3M6IGdldFByZXZpb3VzU2libGluZ3NOdW1iZXIoZWxlbWVudCksXG4gICAgbnVtYmVyT2ZBZnRlclNpYmxpbmdzOiBnZXROZXh0U2libGluZ3NOdW1iZXIoZWxlbWVudCksXG4gICAgYXR0cmlidXRlczogZ2V0QWxsQXR0cmlidXRlcyhlbGVtZW50KSxcbiAgfTtcbn07XG5cbnZhciBnZXROZXh0U2libGluZ3NOdW1iZXIgPSBmdW5jdGlvbiAoZWxlbWVudCkge1xuICB2YXIgbmV4dFNpYmxpbmdzID0gMDtcblxuICB3aGlsZSAoZWxlbWVudC5uZXh0RWxlbWVudFNpYmxpbmcgJiYgbmV4dFNpYmxpbmdzIDwgMTAwKSB7XG4gICAgaWYgKGVsZW1lbnQubm9kZVR5cGUgPT09IDMpIHtcbiAgICAgIGNvbnRpbnVlOyAvLyB0ZXh0IG5vZGUgbm90IGluY2x1ZGVkIGluIG5leHRFbGVtZW50U2libGluZ1xuICAgIH1cbiAgICBlbGVtZW50ID0gZWxlbWVudC5uZXh0RWxlbWVudFNpYmxpbmc7XG5cbiAgICBuZXh0U2libGluZ3MgKz0gMTtcbiAgfVxuXG4gIHJldHVybiBuZXh0U2libGluZ3M7XG59O1xuXG52YXIgZ2V0UHJldmlvdXNTaWJsaW5nc051bWJlciA9IGZ1bmN0aW9uIChlbGVtZW50KSB7XG4gIHZhciBwcmV2aW91c1NpYmxpbmdzID0gMDtcblxuICB3aGlsZSAoZWxlbWVudC5wcmV2aW91c0VsZW1lbnRTaWJsaW5nICYmIHByZXZpb3VzU2libGluZ3MgPCAxMDApIHtcbiAgICBpZiAoZWxlbWVudC5ub2RlVHlwZSA9PT0gMykge1xuICAgICAgY29udGludWU7IC8vIHRleHQgbm9kZSBub3QgaW5jbHVkZWQgaW4gcHJldmlvdXNFbGVtZW50U2libGluZ1xuICAgIH1cbiAgICBlbGVtZW50ID0gZWxlbWVudC5wcmV2aW91c0VsZW1lbnRTaWJsaW5nO1xuXG4gICAgcHJldmlvdXNTaWJsaW5ncyArPSAxO1xuICB9XG5cbiAgcmV0dXJuIHByZXZpb3VzU2libGluZ3M7XG59O1xuXG52YXIgYWRkVG9HbG9iYWxWYXJpYWJsZSA9IGZ1bmN0aW9uICh0ZXN0TGluZUl0ZW1EZXRhaWxzKSB7XG4gIHZhciBlbGVtZW50RGV0YWlscyA9IGNvbnN0cnVjdEVsZW1lbnREZXRhaWwodGVzdExpbmVJdGVtRGV0YWlscy5zZWxlY3RvciwgdGVzdExpbmVJdGVtRGV0YWlscy50ZXN0TGluZUl0ZW1JZCk7XG4gIGlmICh3aW5kb3cudHJ1ZG9uR2xvYmFscykge1xuICAgIHdpbmRvdy50cnVkb25HbG9iYWxzLmVsZW1lbnREZXRhaWxzLnB1c2goZWxlbWVudERldGFpbHMpO1xuICB9XG5cbiAgcmV0dXJuIGVsZW1lbnREZXRhaWxzO1xufTtcblxudmFyIGF0dGFjaEVsZW1lbnREZXRhaWxzVG9HbG9iYWwgPSAoKSA9PiB7XG4gIGlmICh3aW5kb3cudHJ1ZG9uR2xvYmFscykge1xuICAgIHJldHVybiBhZGRUb0dsb2JhbFZhcmlhYmxlKHdpbmRvdy50cnVkb25HbG9iYWxzLmVsZW1lbnQpO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IHtcbiAgYXR0YWNoRWxlbWVudERldGFpbHNUb0dsb2JhbCxcbiAgY29uc3RydWN0RWxlbWVudERldGFpbCxcbn07XG4iXSwiZmlsZSI6ImVsZW1lbnQtZGV0YWlscy1oZWxwZXIuanMifQ==
