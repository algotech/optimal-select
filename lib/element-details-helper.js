"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.attachElementDetailsToGlobal = attachElementDetailsToGlobal;

function attachElementDetailsToGlobal() {
  var getAllAttributes = function getAllAttributes(element) {
    var attributeDetails = {};

    if (!element.attributes) {
      return {};
    }

    var attributes = Array.prototype.slice.call(element.attributes);
    attributes.forEach(function (attribute) {
      attributeDetails[attribute.nodeName] = attribute.nodeValue;
    });
    return attributeDetails;
  };

  var constructParentsArray = function constructParentsArray(element) {
    var parentArray = [];
    var index = 0;

    while (element !== null && index < 10) {
      index += 1;
      parentArray.push(getDirectDetails(element));
      element = element.parentElement;
    } //  start from the html -> body -> ... for better further comparisons.


    parentArray.shift();
    return parentArray;
  };

  var constructDirectChildrenArray = function constructDirectChildrenArray(element) {
    var childrenArray = [];

    if (!element.children) {
      return null;
    }

    var children = Array.prototype.slice.call(element.children);
    children.forEach(function (child) {
      childrenArray.push({
        details: getDirectDetails(child),
        children: constructDirectChildrenArray(child)
      });
    });
    return childrenArray;
  };

  var constructElementDetail = function constructElementDetail(selector, testLineItemId) {
    var domElement = document.querySelector(selector);

    if (!domElement || !window.trudonGlobals) {
      return null;
    }

    var elementDetails = getDirectDetails(domElement);
    elementDetails.testLineItemId = testLineItemId;
    elementDetails.selector = selector;
    elementDetails.nextSibling = domElement.nextElementSibling ? getDirectDetails(domElement.nextElementSibling) : null;
    elementDetails.previousSibling = domElement.previousElementSibling ? getDirectDetails(domElement.previousElementSibling) : null;
    elementDetails.parents = constructParentsArray(domElement);
    elementDetails.children = constructDirectChildrenArray(domElement);
    elementDetails.currentElementGrade = window.trudonGlobals.selectorOptionsHelpers.getFinalGradeForElement(domElement, elementDetails);
    return elementDetails;
  };

  var getDirectDetails = function getDirectDetails(element) {
    var withTextContent = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : true;
    return {
      tag: element.tagName,
      textContent: withTextContent && element.textContent ? element.textContent.replace(/[\n\r\s]+/g, '').substring(0, 128) : null,
      // trim to 128 characters and delete white spaces tabs and new lines
      numberOfPreviousSiblings: getPreviousSiblingsNumber(element),
      numberOfAfterSiblings: getNextSiblingsNumber(element),
      attributes: getAllAttributes(element)
    };
  };

  var getNextSiblingsNumber = function getNextSiblingsNumber(element) {
    var nextSiblings = 0;

    while (element.nextElementSibling && nextSiblings < 100) {
      if (element.nodeType === 3) {
        continue; // text node not included in nextElementSibling
      }

      element = element.nextElementSibling;
      nextSiblings += 1;
    }

    return nextSiblings;
  };

  var getPreviousSiblingsNumber = function getPreviousSiblingsNumber(element) {
    var previousSiblings = 0;

    while (element.previousElementSibling && previousSiblings < 100) {
      if (element.nodeType === 3) {
        continue; // text node not included in previousElementSibling
      }

      element = element.previousElementSibling;
      previousSiblings += 1;
    }

    return previousSiblings;
  };

  var addToGlobalVariable = function addToGlobalVariable(testLineItemDetails) {
    var elementDetails = constructElementDetail(testLineItemDetails.selector, testLineItemDetails.testLineItemId);

    if (window.trudonGlobals) {
      window.trudonGlobals.elementDetails.push(elementDetails);
    }

    return elementDetails;
  };

  if (window.trudonGlobals) {
    return addToGlobalVariable(window.trudonGlobals.element);
  }
}
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImVsZW1lbnQtZGV0YWlscy1oZWxwZXIuanMiXSwibmFtZXMiOlsiYXR0YWNoRWxlbWVudERldGFpbHNUb0dsb2JhbCIsImdldEFsbEF0dHJpYnV0ZXMiLCJlbGVtZW50IiwiYXR0cmlidXRlRGV0YWlscyIsImF0dHJpYnV0ZXMiLCJBcnJheSIsInByb3RvdHlwZSIsInNsaWNlIiwiY2FsbCIsImZvckVhY2giLCJhdHRyaWJ1dGUiLCJub2RlTmFtZSIsIm5vZGVWYWx1ZSIsImNvbnN0cnVjdFBhcmVudHNBcnJheSIsInBhcmVudEFycmF5IiwiaW5kZXgiLCJwdXNoIiwiZ2V0RGlyZWN0RGV0YWlscyIsInBhcmVudEVsZW1lbnQiLCJzaGlmdCIsImNvbnN0cnVjdERpcmVjdENoaWxkcmVuQXJyYXkiLCJjaGlsZHJlbkFycmF5IiwiY2hpbGRyZW4iLCJjaGlsZCIsImRldGFpbHMiLCJjb25zdHJ1Y3RFbGVtZW50RGV0YWlsIiwic2VsZWN0b3IiLCJ0ZXN0TGluZUl0ZW1JZCIsImRvbUVsZW1lbnQiLCJkb2N1bWVudCIsInF1ZXJ5U2VsZWN0b3IiLCJ3aW5kb3ciLCJ0cnVkb25HbG9iYWxzIiwiZWxlbWVudERldGFpbHMiLCJuZXh0U2libGluZyIsIm5leHRFbGVtZW50U2libGluZyIsInByZXZpb3VzU2libGluZyIsInByZXZpb3VzRWxlbWVudFNpYmxpbmciLCJwYXJlbnRzIiwiY3VycmVudEVsZW1lbnRHcmFkZSIsInNlbGVjdG9yT3B0aW9uc0hlbHBlcnMiLCJnZXRGaW5hbEdyYWRlRm9yRWxlbWVudCIsIndpdGhUZXh0Q29udGVudCIsInRhZyIsInRhZ05hbWUiLCJ0ZXh0Q29udGVudCIsInJlcGxhY2UiLCJzdWJzdHJpbmciLCJudW1iZXJPZlByZXZpb3VzU2libGluZ3MiLCJnZXRQcmV2aW91c1NpYmxpbmdzTnVtYmVyIiwibnVtYmVyT2ZBZnRlclNpYmxpbmdzIiwiZ2V0TmV4dFNpYmxpbmdzTnVtYmVyIiwibmV4dFNpYmxpbmdzIiwibm9kZVR5cGUiLCJwcmV2aW91c1NpYmxpbmdzIiwiYWRkVG9HbG9iYWxWYXJpYWJsZSIsInRlc3RMaW5lSXRlbURldGFpbHMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBTyxTQUFTQSw0QkFBVCxHQUF3QztBQUM3QyxNQUFJQyxnQkFBZ0IsR0FBRyxTQUFuQkEsZ0JBQW1CLENBQVVDLE9BQVYsRUFBbUI7QUFDeEMsUUFBSUMsZ0JBQWdCLEdBQUcsRUFBdkI7O0FBRUEsUUFBSSxDQUFDRCxPQUFPLENBQUNFLFVBQWIsRUFBeUI7QUFDdkIsYUFBTyxFQUFQO0FBQ0Q7O0FBRUQsUUFBSUEsVUFBVSxHQUFHQyxLQUFLLENBQUNDLFNBQU4sQ0FBZ0JDLEtBQWhCLENBQXNCQyxJQUF0QixDQUEyQk4sT0FBTyxDQUFDRSxVQUFuQyxDQUFqQjtBQUNBQSxJQUFBQSxVQUFVLENBQUNLLE9BQVgsQ0FBbUIsVUFBVUMsU0FBVixFQUFxQjtBQUN0Q1AsTUFBQUEsZ0JBQWdCLENBQUNPLFNBQVMsQ0FBQ0MsUUFBWCxDQUFoQixHQUF1Q0QsU0FBUyxDQUFDRSxTQUFqRDtBQUNELEtBRkQ7QUFJQSxXQUFPVCxnQkFBUDtBQUNELEdBYkQ7O0FBZUEsTUFBSVUscUJBQXFCLEdBQUcsU0FBeEJBLHFCQUF3QixDQUFVWCxPQUFWLEVBQW1CO0FBQzdDLFFBQUlZLFdBQVcsR0FBRyxFQUFsQjtBQUNBLFFBQUlDLEtBQUssR0FBRyxDQUFaOztBQUVBLFdBQU9iLE9BQU8sS0FBSyxJQUFaLElBQW9CYSxLQUFLLEdBQUcsRUFBbkMsRUFBdUM7QUFDckNBLE1BQUFBLEtBQUssSUFBSSxDQUFUO0FBQ0FELE1BQUFBLFdBQVcsQ0FBQ0UsSUFBWixDQUFpQkMsZ0JBQWdCLENBQUNmLE9BQUQsQ0FBakM7QUFFQUEsTUFBQUEsT0FBTyxHQUFHQSxPQUFPLENBQUNnQixhQUFsQjtBQUNELEtBVDRDLENBVTdDOzs7QUFDQUosSUFBQUEsV0FBVyxDQUFDSyxLQUFaO0FBRUEsV0FBT0wsV0FBUDtBQUNELEdBZEQ7O0FBZ0JBLE1BQUlNLDRCQUE0QixHQUFHLFNB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QUFDeEIsV0FBT3VCLG1CQUFtQixDQUFDeEIsTUFBTSxDQUFDQyxhQUFQLENBQXFCOUIsT0FBdEIsQ0FBMUI7QUFDRDtBQUNGIiwic291cmNlc0NvbnRlbnQiOlsiZXhwb3J0IGZ1bmN0aW9uIGF0dGFjaEVsZW1lbnREZXRhaWxzVG9HbG9iYWwoKSB7XG4gIHZhciBnZXRBbGxBdHRyaWJ1dGVzID0gZnVuY3Rpb24gKGVsZW1lbnQpIHtcbiAgICB2YXIgYXR0cmlidXRlRGV0YWlscyA9IHt9O1xuXG4gICAgaWYgKCFlbGVtZW50LmF0dHJpYnV0ZXMpIHtcbiAgICAgIHJldHVybiB7fTtcbiAgICB9XG5cbiAgICB2YXIgYXR0cmlidXRlcyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGVsZW1lbnQuYXR0cmlidXRlcyk7XG4gICAgYXR0cmlidXRlcy5mb3JFYWNoKGZ1bmN0aW9uIChhdHRyaWJ1dGUpIHtcbiAgICAgIGF0dHJpYnV0ZURldGFpbHNbYXR0cmlidXRlLm5vZGVOYW1lXSA9IGF0dHJpYnV0ZS5ub2RlVmFsdWU7XG4gICAgfSk7XG5cbiAgICByZXR1cm4gYXR0cmlidXRlRGV0YWlscztcbiAgfTtcblxuICB2YXIgY29uc3RydWN0UGFyZW50c0FycmF5ID0gZnVuY3Rpb24gKGVsZW1lbnQpIHtcbiAgICB2YXIgcGFyZW50QXJyYXkgPSBbXTtcbiAgICB2YXIgaW5kZXggPSAwO1xuXG4gICAgd2hpbGUgKGVsZW1lbnQgIT09IG51bGwgJiYgaW5kZXggPCAxMCkge1xuICAgICAgaW5kZXggKz0gMTtcbiAgICAgIHBhcmVudEFycmF5LnB1c2goZ2V0RGlyZWN0RGV0YWlscyhlbGVtZW50KSk7XG5cbiAgICAgIGVsZW1lbnQgPSBlbGVtZW50LnBhcmVudEVsZW1lbnQ7XG4gICAgfVxuICAgIC8vICBzdGFydCBmcm9tIHRoZSBodG1sIC0+IGJvZHkgLT4gLi4uIGZvciBiZXR0ZXIgZnVydGhlciBjb21wYXJpc29ucy5cbiAgICBwYXJlbnRBcnJheS5zaGlmdCgpO1xuXG4gICAgcmV0dXJuIHBhcmVudEFycmF5O1xuICB9O1xuXG4gIHZhciBjb25zdHJ1Y3REaXJlY3RDaGlsZHJlbkFycmF5ID0gZnVuY3Rpb24gKGVsZW1lbnQpIHtcbiAgICB2YXIgY2hpbGRyZW5BcnJheSA9IFtdO1xuXG4gICAgaWYgKCFlbGVtZW50LmNoaWxkcmVuKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICB2YXIgY2hpbGRyZW4gPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChlbGVtZW50LmNoaWxkcmVuKTtcblxuICAgIGNoaWxkcmVuLmZvckVhY2goZnVuY3Rpb24gKGNoaWxkKSB7XG4gICAgICBjaGlsZHJlbkFycmF5LnB1c2goe1xuICAgICAgICBkZXRhaWxzOiBnZXREaXJlY3REZXRhaWxzKGNoaWxkKSxcbiAgICAgICAgY2hpbGRyZW46IGNvbnN0cnVjdERpcmVjdENoaWxkcmVuQXJyYXkoY2hpbGQpLFxuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICByZXR1cm4gY2hpbGRyZW5BcnJheTtcbiAgfTtcblxuICB2YXIgY29uc3RydWN0RWxlbWVudERldGFpbCA9IGZ1bmN0aW9uIChzZWxlY3RvciwgdGVzdExpbmVJdGVtSWQpIHtcbiAgICB2YXIgZG9tRWxlbWVudCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3Ioc2VsZWN0b3IpO1xuXG4gICAgaWYgKCFkb21FbGVtZW50IHx8ICF3aW5kb3cudHJ1ZG9uR2xvYmFscykge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgdmFyIGVsZW1lbnREZXRhaWxzID0gZ2V0RGlyZWN0RGV0YWlscyhkb21FbGVtZW50KTtcbiAgICBlbGVtZW50RGV0YWlscy50ZXN0TGluZUl0ZW1JZCA9IHRlc3RMaW5lSXRlbUlkO1xuICAgIGVsZW1lbnREZXRhaWxzLnNlbGVjdG9yID0gc2VsZWN0b3I7XG4gICAgZWxlbWVudERldGFpbHMubmV4dFNpYmxpbmcgPSBkb21FbGVtZW50Lm5leHRFbGVtZW50U2libGluZyA/IGdldERpcmVjdERldGFpbHMoZG9tRWxlbWVudC5uZXh0RWxlbWVudFNpYmxpbmcpIDogbnVsbDtcbiAgICBlbGVtZW50RGV0YWlscy5wcmV2aW91c1NpYmxpbmcgPSBkb21FbGVtZW50LnByZXZpb3VzRWxlbWVudFNpYmxpbmcgPyBnZXREaXJlY3REZXRhaWxzKGRvbUVsZW1lbnQucHJldmlvdXNFbGVtZW50U2libGluZykgOiBudWxsO1xuICAgIGVsZW1lbnREZXRhaWxzLnBhcmVudHMgPSBjb25zdHJ1Y3RQYXJlbnRzQXJyYXkoZG9tRWxlbWVudCk7XG4gICAgZWxlbWVudERldGFpbHMuY2hpbGRyZW4gPSBjb25zdHJ1Y3REaXJlY3RDaGlsZHJlbkFycmF5KGRvbUVsZW1lbnQpO1xuICAgIGVsZW1lbnREZXRhaWxzLmN1cnJlbnRFbGVtZW50R3JhZGUgPSB3aW5kb3cudHJ1ZG9uR2xvYmFscy5zZWxlY3Rvck9wdGlvbnNIZWxwZXJzLmdldEZpbmFsR3JhZGVGb3JFbGVtZW50KGRvbUVsZW1lbnQsIGVsZW1lbnREZXRhaWxzKTtcblxuICAgIHJldHVybiBlbGVtZW50RGV0YWlscztcbiAgfTtcblxuICB2YXIgZ2V0RGlyZWN0RGV0YWlscyA9IGZ1bmN0aW9uIChlbGVtZW50LCB3aXRoVGV4dENvbnRlbnQgPSB0cnVlKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHRhZzogZWxlbWVudC50YWdOYW1lLFxuICAgICAgdGV4dENvbnRlbnQ6IHdpdGhUZXh0Q29udGVudCAmJiBlbGVtZW50LnRleHRDb250ZW50ID8gZWxlbWVudC50ZXh0Q29udGVudC5yZXBsYWNlKC9bXFxuXFxyXFxzXSsvZywgJycpLnN1YnN0cmluZygwLCAxMjgpIDogbnVsbCwgLy8gdHJpbSB0byAxMjggY2hhcmFjdGVycyBhbmQgZGVsZXRlIHdoaXRlIHNwYWNlcyB0YWJzIGFuZCBuZXcgbGluZXNcbiAgICAgIG51bWJlck9mUHJldmlvdXNTaWJsaW5nczogZ2V0UHJldmlvdXNTaWJsaW5nc051bWJlcihlbGVtZW50KSxcbiAgICAgIG51bWJlck9mQWZ0ZXJTaWJsaW5nczogZ2V0TmV4dFNpYmxpbmdzTnVtYmVyKGVsZW1lbnQpLFxuICAgICAgYXR0cmlidXRlczogZ2V0QWxsQXR0cmlidXRlcyhlbGVtZW50KSxcbiAgICB9O1xuICB9O1xuXG4gIHZhciBnZXROZXh0U2libGluZ3NOdW1iZXIgPSBmdW5jdGlvbiAoZWxlbWVudCkge1xuICAgIHZhciBuZXh0U2libGluZ3MgPSAwO1xuXG4gICAgd2hpbGUgKGVsZW1lbnQubmV4dEVsZW1lbnRTaWJsaW5nICYmIG5leHRTaWJsaW5ncyA8IDEwMCkge1xuICAgICAgaWYgKGVsZW1lbnQubm9kZVR5cGUgPT09IDMpIHtcbiAgICAgICAgY29udGludWU7IC8vIHRleHQgbm9kZSBub3QgaW5jbHVkZWQgaW4gbmV4dEVsZW1lbnRTaWJsaW5nXG4gICAgICB9XG4gICAgICBlbGVtZW50ID0gZWxlbWVudC5uZXh0RWxlbWVudFNpYmxpbmc7XG5cbiAgICAgIG5leHRTaWJsaW5ncyArPSAxO1xuICAgIH1cblxuICAgIHJldHVybiBuZXh0U2libGluZ3M7XG4gIH07XG5cbiAgdmFyIGdldFByZXZpb3VzU2libGluZ3NOdW1iZXIgPSBmdW5jdGlvbiAoZWxlbWVudCkge1xuICAgIHZhciBwcmV2aW91c1NpYmxpbmdzID0gMDtcblxuICAgIHdoaWxlIChlbGVtZW50LnByZXZpb3VzRWxlbWVudFNpYmxpbmcgJiYgcHJldmlvdXNTaWJsaW5ncyA8IDEwMCkge1xuICAgICAgaWYgKGVsZW1lbnQubm9kZVR5cGUgPT09IDMpIHtcbiAgICAgICAgY29udGludWU7IC8vIHRleHQgbm9kZSBub3QgaW5jbHVkZWQgaW4gcHJldmlvdXNFbGVtZW50U2libGluZ1xuICAgICAgfVxuICAgICAgZWxlbWVudCA9IGVsZW1lbnQucHJldmlvdXNFbGVtZW50U2libGluZztcblxuICAgICAgcHJldmlvdXNTaWJsaW5ncyArPSAxO1xuICAgIH1cblxuICAgIHJldHVybiBwcmV2aW91c1NpYmxpbmdzO1xuICB9O1xuXG4gIHZhciBhZGRUb0dsb2JhbFZhcmlhYmxlID0gZnVuY3Rpb24gKHRlc3RMaW5lSXRlbURldGFpbHMpIHtcbiAgICB2YXIgZWxlbWVudERldGFpbHMgPSBjb25zdHJ1Y3RFbGVtZW50RGV0YWlsKHRlc3RMaW5lSXRlbURldGFpbHMuc2VsZWN0b3IsIHRlc3RMaW5lSXRlbURldGFpbHMudGVzdExpbmVJdGVtSWQpO1xuICAgIGlmICh3aW5kb3cudHJ1ZG9uR2xvYmFscykge1xuICAgICAgd2luZG93LnRydWRvbkdsb2JhbHMuZWxlbWVudERldGFpbHMucHVzaChlbGVtZW50RGV0YWlscyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGVsZW1lbnREZXRhaWxzO1xuICB9O1xuXG4gIGlmICh3aW5kb3cudHJ1ZG9uR2xvYmFscykge1xuICAgIHJldHVybiBhZGRUb0dsb2JhbFZhcmlhYmxlKHdpbmRvdy50cnVkb25HbG9iYWxzLmVsZW1lbnQpO1xuICB9XG59XG4iXSwiZmlsZSI6ImVsZW1lbnQtZGV0YWlscy1oZWxwZXIuanMifQ==
