"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var attachElementDetailsToGlobal = function attachElementDetailsToGlobal() {
  var needConstructElementDetails = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : false;

  var getAllAttributes = function getAllAttributes(element) {
    var attributeDetails = {};

    if (!element.attributes) {
      return {};
    }

    var attributes = Array.prototype.slice.call(element.attributes);
    attributes.forEach(function (attribute) {
      attributeDetails[attribute.nodeName] = attribute.nodeValue;
    });
    return attributeDetails;
  };

  var constructParentsArray = function constructParentsArray(element) {
    var parentArray = [];
    var index = 0;

    if (!element.parentElement) {
      return parentArray;
    }

    element = element.parentElement;

    while (element !== null && index < 10) {
      index += 1;
      parentArray.push(getDirectDetails(element));
      element = element.parentElement;
    }

    return parentArray;
  };

  var constructDirectChildrenArray = function constructDirectChildrenArray(element) {
    var childrenArray = [];

    if (!element.children) {
      return null;
    }

    var children = Array.prototype.slice.call(element.children);
    children.forEach(function (child) {
      childrenArray.push({
        details: getDirectDetails(child),
        children: constructDirectChildrenArray(child)
      });
    });
    return childrenArray;
  };

  var constructElementDetails = function constructElementDetails(selector, testLineItemId) {
    var requestedByExtension = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : false;
    var domElement = document.querySelector(selector);

    if (!domElement || !window.trudonGlobals && !requestedByExtension) {
      return null;
    }

    var elementDetails = getDirectDetails(domElement);

    if (testLineItemId) {
      elementDetails.testLineItemId = testLineItemId;
    }

    elementDetails.selector = selector;
    elementDetails.nextSibling = domElement.nextElementSibling ? getDirectDetails(domElement.nextElementSibling) : null;
    elementDetails.previousSibling = domElement.previousElementSibling ? getDirectDetails(domElement.previousElementSibling) : null;
    elementDetails.parents = constructParentsArray(domElement);
    elementDetails.children = constructDirectChildrenArray(domElement);

    if (window.trudonGlobals) {
      elementDetails.currentElementGrade = window.trudonGlobals.selectorOptionsHelpers.getFinalGradeForElement(domElement, elementDetails);
    }

    return elementDetails;
  };

  var getDirectDetails = function getDirectDetails(element) {
    var withTextContent = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : true;
    return {
      tag: element.tagName,
      textContent: withTextContent && element.textContent ? element.textContent.replace(/[\n\r\s]+/g, '').substring(0, 128) : null,
      // trim to 128 characters and delete white spaces tabs and new lines
      numberOfPreviousSiblings: getPreviousSiblingsNumber(element),
      numberOfAfterSiblings: getNextSiblingsNumber(element),
      attributes: getAllAttributes(element)
    };
  };

  var getNextSiblingsNumber = function getNextSiblingsNumber(element) {
    var nextSiblings = 0;

    while (element.nextElementSibling && nextSiblings < 100) {
      if (element.nodeType === 3) {
        continue; // text node not included in nextElementSibling
      }

      element = element.nextElementSibling;
      nextSiblings += 1;
    }

    return nextSiblings;
  };

  var getPreviousSiblingsNumber = function getPreviousSiblingsNumber(element) {
    var previousSiblings = 0;

    while (element.previousElementSibling && previousSiblings < 100) {
      if (element.nodeType === 3) {
        continue; // text node not included in previousElementSibling
      }

      element = element.previousElementSibling;
      previousSiblings += 1;
    }

    return previousSiblings;
  };

  var addToGlobalVariable = function addToGlobalVariable(testLineItemDetails) {
    var elementDetails = constructElementDetails(testLineItemDetails.selector, testLineItemDetails.testLineItemId);

    if (window.trudonGlobals) {
      window.trudonGlobals.elementDetails.push(elementDetails);
    }

    return elementDetails;
  };

  if (returnConstructElementDetails) {
    return constructElementDetails;
  }

  if (window.trudonGlobals) {
    return addToGlobalVariable(window.trudonGlobals.element);
  }
};

var _default = {
  attachElementDetailsToGlobal: attachElementDetailsToGlobal,
  constructElementDetails: attachElementDetailsToGlobal(true)
};
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImVsZW1lbnQtZGV0YWlscy1oZWxwZXIuanMiXSwibmFtZXMiOlsiYXR0YWNoRWxlbWVudERldGFpbHNUb0dsb2JhbCIsIm5lZWRDb25zdHJ1Y3RFbGVtZW50RGV0YWlscyIsImdldEFsbEF0dHJpYnV0ZXMiLCJlbGVtZW50IiwiYXR0cmlidXRlRGV0YWlscyIsImF0dHJpYnV0ZXMiLCJBcnJheSIsInByb3RvdHlwZSIsInNsaWNlIiwiY2FsbCIsImZvckVhY2giLCJhdHRyaWJ1dGUiLCJub2RlTmFtZSIsIm5vZGVWYWx1ZSIsImNvbnN0cnVjdFBhcmVudHNBcnJheSIsInBhcmVudEFycmF5IiwiaW5kZXgiLCJwYXJlbnRFbGVtZW50IiwicHVzaCIsImdldERpcmVjdERldGFpbHMiLCJjb25zdHJ1Y3REaXJlY3RDaGlsZHJlbkFycmF5IiwiY2hpbGRyZW5BcnJheSIsImNoaWxkcmVuIiwiY2hpbGQiLCJkZXRhaWxzIiwiY29uc3RydWN0RWxlbWVudERldGFpbHMiLCJzZWxlY3RvciIsInRlc3RMaW5lSXRlbUlkIiwicmVxdWVzdGVkQnlFeHRlbnNpb24iLCJkb21FbGVtZW50IiwiZG9jdW1lbnQiLCJxdWVyeVNlbGVjdG9yIiwid2luZG93IiwidHJ1ZG9uR2xvYmFscyIsImVsZW1lbnREZXRhaWxzIiwibmV4dFNpYmxpbmciLCJuZXh0RWxlbWVudFNpYmxpbmciLCJwcmV2aW91c1NpYmxpbmciLCJwcmV2aW91c0VsZW1lbnRTaWJsaW5nIiwicGFyZW50cyIsImN1cnJlbnRFbGVtZW50R3JhZGUiLCJzZWxlY3Rvck9wdGlvbnNIZWxwZXJzIiwiZ2V0RmluYWxHcmFkZUZvckVsZW1lbnQiLCJ3aXRoVGV4dENvbnRlbnQiLCJ0YWciLCJ0YWdOYW1lIiwidGV4dENvbnRlbnQiLCJyZXBsYWNlIiwic3Vic3RyaW5nIiwibnVtYmVyT2ZQcmV2aW91c1NpYmxpbmdzIiwiZ2V0UHJldmlvdXNTaWJsaW5nc051bWJlciIsIm51bWJlck9mQWZ0ZXJTaWJsaW5ncyIsImdldE5leHRTaWJsaW5nc051bWJlciIsIm5leHRTaWJsaW5ncyIsIm5vZGVUeXBlIiwicHJldmlvdXNTaWJsaW5ncyIsImFkZFRvR2xvYmFsVmFyaWFibGUiLCJ0ZXN0TGluZUl0ZW1EZXRhaWxzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUEsSUFBSUEsNEJBQTRCLEdBQUcsU0FBL0JBLDRCQUErQixHQUF5QztBQUFBLE1BQXhDQywyQkFBd0MsdUVBQVYsS0FBVTs7QUFDMUUsTUFBSUMsZ0JBQWdCLEdBQUcsU0FBbkJBLGdCQUFtQixDQUFVQyxPQUFWLEVBQW1CO0FBQ3hDLFFBQUlDLGdCQUFnQixHQUFHLEVBQXZCOztBQUVBLFFBQUksQ0FBQ0QsT0FBTyxDQUFDRSxVQUFiLEVBQXlCO0FBQ3ZCLGFBQU8sRUFBUDtBQUNEOztBQUVELFFBQUlBLFVBQVUsR0FBR0MsS0FBSyxDQUFDQyxTQUFOLENBQWdCQyxLQUFoQixDQUFzQkMsSUFBdEIsQ0FBMkJOLE9BQU8sQ0FBQ0UsVUFBbkMsQ0FBakI7QUFDQUEsSUFBQUEsVUFBVSxDQUFDSyxPQUFYLENBQW1CLFVBQVVDLFNBQVYsRUFBcUI7QUFDdENQLE1BQUFBLGdCQUFnQixDQUFDTyxTQUFTLENBQUNDLFFBQVgsQ0FBaEIsR0FBdUNELFNBQVMsQ0FBQ0UsU0FBakQ7QUFDRCxLQUZEO0FBSUEsV0FBT1QsZ0JBQVA7QUFDRCxHQWJEOztBQWVBLE1BQUlVLHFCQUFxQixHQUFHLFNBQXhCQSxxQkFBd0IsQ0FBVVgsT0FBVixFQUFtQjtBQUM3QyxRQUFJWSxXQUFXLEdBQUcsRUFBbEI7QUFDQSxRQUFJQyxLQUFLLEdBQUcsQ0FBWjs7QUFFQSxRQUFJLENBQUNiLE9BQU8sQ0FBQ2MsYUFBYixFQUE0QjtBQUMxQixhQUFPRixXQUFQO0FBQ0Q7O0FBRURaLElBQUFBLE9BQU8sR0FBR0EsT0FBTyxDQUFDYyxhQUFsQjs7QUFFQSxXQUFPZCxPQUFPLEtBQUssSUFBWixJQUFvQmEsS0FBSyxHQUFHLEVBQW5DLEVBQXVDO0FBQ3JDQSxNQUFBQSxLQUFLLElBQUksQ0FBVDtB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QVVDLG1CQUFWLEVBQStCO0FBQ3ZELFFBQUl2QixjQUFjLEdBQUdULHVCQUF1QixDQUFDZ0MsbUJBQW1CLENBQUMvQixRQUFyQixFQUErQitCLG1CQUFtQixDQUFDOUIsY0FBbkQsQ0FBNUM7O0FBQ0EsUUFBSUssTUFBTSxDQUFDQyxhQUFYLEVBQTBCO0FBQ3hCRCxNQUFBQSxNQUFNLENBQUNDLGFBQVAsQ0FBcUJDLGNBQXJCLENBQW9DaEIsSUFBcEMsQ0FBeUNnQixjQUF6QztBQUNEOztBQUVELFdBQU9BLGNBQVA7QUFDRCxHQVBEOztBQVNBLE1BQUlqQywyQkFBSixFQUFpQztBQUMvQixXQUFPd0IsdUJBQVA7QUFDRDs7QUFDRCxNQUFJTyxNQUFNLENBQUNDLGFBQVgsRUFBMEI7QUFDeEIsV0FBT3VCLG1CQUFtQixDQUFDeEIsTUFBTSxDQUFDQyxhQUFQLENBQXFCOUIsT0FBdEIsQ0FBMUI7QUFDRDtBQUNGLENBcklEOztlQXVJZTtBQUNiSCxFQUFBQSw0QkFBNEIsRUFBNUJBLDRCQURhO0FBRWJ5QixFQUFBQSx1QkFBdUIsRUFBRXpCLDRCQUE0QixDQUFDLElBQUQ7QUFGeEMsQyIsInNvdXJjZXNDb250ZW50IjpbInZhciBhdHRhY2hFbGVtZW50RGV0YWlsc1RvR2xvYmFsID0gKG5lZWRDb25zdHJ1Y3RFbGVtZW50RGV0YWlscyA9IGZhbHNlKSA9PiB7XG4gIHZhciBnZXRBbGxBdHRyaWJ1dGVzID0gZnVuY3Rpb24gKGVsZW1lbnQpIHtcbiAgICB2YXIgYXR0cmlidXRlRGV0YWlscyA9IHt9O1xuXG4gICAgaWYgKCFlbGVtZW50LmF0dHJpYnV0ZXMpIHtcbiAgICAgIHJldHVybiB7fTtcbiAgICB9XG5cbiAgICB2YXIgYXR0cmlidXRlcyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGVsZW1lbnQuYXR0cmlidXRlcyk7XG4gICAgYXR0cmlidXRlcy5mb3JFYWNoKGZ1bmN0aW9uIChhdHRyaWJ1dGUpIHtcbiAgICAgIGF0dHJpYnV0ZURldGFpbHNbYXR0cmlidXRlLm5vZGVOYW1lXSA9IGF0dHJpYnV0ZS5ub2RlVmFsdWU7XG4gICAgfSk7XG5cbiAgICByZXR1cm4gYXR0cmlidXRlRGV0YWlscztcbiAgfTtcblxuICB2YXIgY29uc3RydWN0UGFyZW50c0FycmF5ID0gZnVuY3Rpb24gKGVsZW1lbnQpIHtcbiAgICB2YXIgcGFyZW50QXJyYXkgPSBbXTtcbiAgICB2YXIgaW5kZXggPSAwO1xuXG4gICAgaWYgKCFlbGVtZW50LnBhcmVudEVsZW1lbnQpIHtcbiAgICAgIHJldHVybiBwYXJlbnRBcnJheTtcbiAgICB9XG5cbiAgICBlbGVtZW50ID0gZWxlbWVudC5wYXJlbnRFbGVtZW50O1xuXG4gICAgd2hpbGUgKGVsZW1lbnQgIT09IG51bGwgJiYgaW5kZXggPCAxMCkge1xuICAgICAgaW5kZXggKz0gMTtcbiAgICAgIHBhcmVudEFycmF5LnB1c2goZ2V0RGlyZWN0RGV0YWlscyhlbGVtZW50KSk7XG5cbiAgICAgIGVsZW1lbnQgPSBlbGVtZW50LnBhcmVudEVsZW1lbnQ7XG4gICAgfVxuXG4gICAgcmV0dXJuIHBhcmVudEFycmF5O1xuICB9O1xuXG4gIHZhciBjb25zdHJ1Y3REaXJlY3RDaGlsZHJlbkFycmF5ID0gZnVuY3Rpb24gKGVsZW1lbnQpIHtcbiAgICB2YXIgY2hpbGRyZW5BcnJheSA9IFtdO1xuXG4gICAgaWYgKCFlbGVtZW50LmNoaWxkcmVuKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICB2YXIgY2hpbGRyZW4gPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChlbGVtZW50LmNoaWxkcmVuKTtcblxuICAgIGNoaWxkcmVuLmZvckVhY2goZnVuY3Rpb24gKGNoaWxkKSB7XG4gICAgICBjaGlsZHJlbkFycmF5LnB1c2goe1xuICAgICAgICBkZXRhaWxzOiBnZXREaXJlY3REZXRhaWxzKGNoaWxkKSxcbiAgICAgICAgY2hpbGRyZW46IGNvbnN0cnVjdERpcmVjdENoaWxkcmVuQXJyYXkoY2hpbGQpLFxuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICByZXR1cm4gY2hpbGRyZW5BcnJheTtcbiAgfTtcblxuICB2YXIgY29uc3RydWN0RWxlbWVudERldGFpbHMgPSBmdW5jdGlvbiAoc2VsZWN0b3IsIHRlc3RMaW5lSXRlbUlkLCByZXF1ZXN0ZWRCeUV4dGVuc2lvbiA9IGZhbHNlKSB7XG4gICAgdmFyIGRvbUVsZW1lbnQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKHNlbGVjdG9yKTtcblxuICAgIGlmICghZG9tRWxlbWVudCB8fCAoIXdpbmRvdy50cnVkb25HbG9iYWxzICYmICFyZXF1ZXN0ZWRCeUV4dGVuc2lvbikpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIHZhciBlbGVtZW50RGV0YWlscyA9IGdldERpcmVjdERldGFpbHMoZG9tRWxlbWVudCk7XG4gICAgaWYgKHRlc3RMaW5lSXRlbUlkKSB7XG4gICAgICBlbGVtZW50RGV0YWlscy50ZXN0TGluZUl0ZW1JZCA9IHRlc3RMaW5lSXRlbUlkO1xuICAgIH1cbiAgICBlbGVtZW50RGV0YWlscy5zZWxlY3RvciA9IHNlbGVjdG9yO1xuICAgIGVsZW1lbnREZXRhaWxzLm5leHRTaWJsaW5nID0gZG9tRWxlbWVudC5uZXh0RWxlbWVudFNpYmxpbmcgPyBnZXREaXJlY3REZXRhaWxzKGRvbUVsZW1lbnQubmV4dEVsZW1lbnRTaWJsaW5nKSA6IG51bGw7XG4gICAgZWxlbWVudERldGFpbHMucHJldmlvdXNTaWJsaW5nID0gZG9tRWxlbWVudC5wcmV2aW91c0VsZW1lbnRTaWJsaW5nID8gZ2V0RGlyZWN0RGV0YWlscyhkb21FbGVtZW50LnByZXZpb3VzRWxlbWVudFNpYmxpbmcpIDogbnVsbDtcbiAgICBlbGVtZW50RGV0YWlscy5wYXJlbnRzID0gY29uc3RydWN0UGFyZW50c0FycmF5KGRvbUVsZW1lbnQpO1xuICAgIGVsZW1lbnREZXRhaWxzLmNoaWxkcmVuID0gY29uc3RydWN0RGlyZWN0Q2hpbGRyZW5BcnJheShkb21FbGVtZW50KTtcbiAgICBpZiAod2luZG93LnRydWRvbkdsb2JhbHMpIHtcbiAgICAgIGVsZW1lbnREZXRhaWxzLmN1cnJlbnRFbGVtZW50R3JhZGUgPSB3aW5kb3cudHJ1ZG9uR2xvYmFscy5zZWxlY3Rvck9wdGlvbnNIZWxwZXJzLmdldEZpbmFsR3JhZGVGb3JFbGVtZW50KGRvbUVsZW1lbnQsIGVsZW1lbnREZXRhaWxzKTtcbiAgICB9XG5cbiAgICByZXR1cm4gZWxlbWVudERldGFpbHM7XG4gIH07XG5cbiAgdmFyIGdldERpcmVjdERldGFpbHMgPSBmdW5jdGlvbiAoZWxlbWVudCwgd2l0aFRleHRDb250ZW50ID0gdHJ1ZSkge1xuICAgIHJldHVybiB7XG4gICAgICB0YWc6IGVsZW1lbnQudGFnTmFtZSxcbiAgICAgIHRleHRDb250ZW50OiB3aXRoVGV4dENvbnRlbnQgJiYgZWxlbWVudC50ZXh0Q29udGVudCA/IGVsZW1lbnQudGV4dENvbnRlbnQucmVwbGFjZSgvW1xcblxcclxcc10rL2csICcnKS5zdWJzdHJpbmcoMCwgMTI4KSA6IG51bGwsIC8vIHRyaW0gdG8gMTI4IGNoYXJhY3RlcnMgYW5kIGRlbGV0ZSB3aGl0ZSBzcGFjZXMgdGFicyBhbmQgbmV3IGxpbmVzXG4gICAgICBudW1iZXJPZlByZXZpb3VzU2libGluZ3M6IGdldFByZXZpb3VzU2libGluZ3NOdW1iZXIoZWxlbWVudCksXG4gICAgICBudW1iZXJPZkFmdGVyU2libGluZ3M6IGdldE5leHRTaWJsaW5nc051bWJlcihlbGVtZW50KSxcbiAgICAgIGF0dHJpYnV0ZXM6IGdldEFsbEF0dHJpYnV0ZXMoZWxlbWVudCksXG4gICAgfTtcbiAgfTtcblxuICB2YXIgZ2V0TmV4dFNpYmxpbmdzTnVtYmVyID0gZnVuY3Rpb24gKGVsZW1lbnQpIHtcbiAgICB2YXIgbmV4dFNpYmxpbmdzID0gMDtcblxuICAgIHdoaWxlIChlbGVtZW50Lm5leHRFbGVtZW50U2libGluZyAmJiBuZXh0U2libGluZ3MgPCAxMDApIHtcbiAgICAgIGlmIChlbGVtZW50Lm5vZGVUeXBlID09PSAzKSB7XG4gICAgICAgIGNvbnRpbnVlOyAvLyB0ZXh0IG5vZGUgbm90IGluY2x1ZGVkIGluIG5leHRFbGVtZW50U2libGluZ1xuICAgICAgfVxuICAgICAgZWxlbWVudCA9IGVsZW1lbnQubmV4dEVsZW1lbnRTaWJsaW5nO1xuXG4gICAgICBuZXh0U2libGluZ3MgKz0gMTtcbiAgICB9XG5cbiAgICByZXR1cm4gbmV4dFNpYmxpbmdzO1xuICB9O1xuXG4gIHZhciBnZXRQcmV2aW91c1NpYmxpbmdzTnVtYmVyID0gZnVuY3Rpb24gKGVsZW1lbnQpIHtcbiAgICB2YXIgcHJldmlvdXNTaWJsaW5ncyA9IDA7XG5cbiAgICB3aGlsZSAoZWxlbWVudC5wcmV2aW91c0VsZW1lbnRTaWJsaW5nICYmIHByZXZpb3VzU2libGluZ3MgPCAxMDApIHtcbiAgICAgIGlmIChlbGVtZW50Lm5vZGVUeXBlID09PSAzKSB7XG4gICAgICAgIGNvbnRpbnVlOyAvLyB0ZXh0IG5vZGUgbm90IGluY2x1ZGVkIGluIHByZXZpb3VzRWxlbWVudFNpYmxpbmdcbiAgICAgIH1cbiAgICAgIGVsZW1lbnQgPSBlbGVtZW50LnByZXZpb3VzRWxlbWVudFNpYmxpbmc7XG5cbiAgICAgIHByZXZpb3VzU2libGluZ3MgKz0gMTtcbiAgICB9XG5cbiAgICByZXR1cm4gcHJldmlvdXNTaWJsaW5ncztcbiAgfTtcblxuICB2YXIgYWRkVG9HbG9iYWxWYXJpYWJsZSA9IGZ1bmN0aW9uICh0ZXN0TGluZUl0ZW1EZXRhaWxzKSB7XG4gICAgdmFyIGVsZW1lbnREZXRhaWxzID0gY29uc3RydWN0RWxlbWVudERldGFpbHModGVzdExpbmVJdGVtRGV0YWlscy5zZWxlY3RvciwgdGVzdExpbmVJdGVtRGV0YWlscy50ZXN0TGluZUl0ZW1JZCk7XG4gICAgaWYgKHdpbmRvdy50cnVkb25HbG9iYWxzKSB7XG4gICAgICB3aW5kb3cudHJ1ZG9uR2xvYmFscy5lbGVtZW50RGV0YWlscy5wdXNoKGVsZW1lbnREZXRhaWxzKTtcbiAgICB9XG5cbiAgICByZXR1cm4gZWxlbWVudERldGFpbHM7XG4gIH07XG5cbiAgaWYgKG5lZWRDb25zdHJ1Y3RFbGVtZW50RGV0YWlscykge1xuICAgIHJldHVybiBjb25zdHJ1Y3RFbGVtZW50RGV0YWlscztcbiAgfVxuICBpZiAod2luZG93LnRydWRvbkdsb2JhbHMpIHtcbiAgICByZXR1cm4gYWRkVG9HbG9iYWxWYXJpYWJsZSh3aW5kb3cudHJ1ZG9uR2xvYmFscy5lbGVtZW50KTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCB7XG4gIGF0dGFjaEVsZW1lbnREZXRhaWxzVG9HbG9iYWwsXG4gIGNvbnN0cnVjdEVsZW1lbnREZXRhaWxzOiBhdHRhY2hFbGVtZW50RGV0YWlsc1RvR2xvYmFsKHRydWUpLFxufTtcbiJdLCJmaWxlIjoiZWxlbWVudC1kZXRhaWxzLWhlbHBlci5qcyJ9
