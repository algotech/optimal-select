"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var attachComputeOverlayStylesToGlobal = function attachComputeOverlayStylesToGlobal() {
  var returnOnlyComputeOverlayStyles = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : false;

  function computeOverlayStyles(target, borderWidth) {
    var widthHeightFactor = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : 1;
    var leftTopFactor = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : 1;
    var returnOnlyCoords = arguments.length > 4 && arguments[4] !== undefined ? arguments[4] : false;

    function elementExistsInDOM(element) {
      return document.body.contains(element);
    }

    function hasParentWithPositionFixed(element) {
      // eslint-disable-next-line no-cond-assign
      do {
        if (getComputedStyle(element).position === 'fixed') {
          return true;
        }
      } while (element = element.offsetParent);

      return false;
    }
    /**
    * Checks if the given pseudo element is bigger than the target element
    * @param {Element} element The element to compare the pseudo element with
    * @param {String} pseudoElement One of ':before' or ':after'
    * @return {Object}         Object containing top, left, width, height in px
    *                          ;null if not bigger
    */


    function isPseudoElementBigger(element, pseudoElement) {
      var _getComputedStyle = getComputedStyle(element, pseudoElement),
          left = _getComputedStyle.left,
          top = _getComputedStyle.top,
          marginLeft = _getComputedStyle.marginLeft,
          marginTop = _getComputedStyle.marginTop,
          width = _getComputedStyle.width,
          height = _getComputedStyle.height;

      var _element$getBoundingC = element.getBoundingClientRect(),
          elementWidth = _element$getBoundingC.width,
          elementHeight = _element$getBoundingC.height;

      var _ref = [element.offsetLeft, element.offsetTop],
          elementLeft = _ref[0],
          elementTop = _ref[1];

      if ((Number.isNaN(parseInt(width, 10)) || parseInt(width, 10) <= elementWidth) && (Number.isNaN(parseInt(height, 10)) || parseInt(height, 10) <= elementHeight)) {
        return null;
      }

      var differenceTop = (parseInt(top, 10) || 0) + (parseInt(marginTop, 10) || 0);
      var differenceLeft = (parseInt(left, 10) || 0) + (parseInt(marginLeft, 10) || 0);
      return {
        left: elementLeft + differenceLeft,
        top: elementTop + differenceTop,
        width: Math.max(parseInt(width, 10), elementWidth) || elementWidth,
        height: Math.max(parseInt(height, 10), elementHeight) || elementHeight
      };
    }

    function isAnyPseudoElementBiggerThanElement(target) {
      var beforeBigger = isPseudoElementBigger(target, ':before');
      var afterBigger = isPseudoElementBigger(target, ':after');

      if (beforeBigger && afterBigger) {
        if (beforeBigger.width * beforeBigger.height > afterBigger.width * afterBigger.height) {
          return beforeBigger;
        }

        return afterBigger;
      }

      return beforeBigger || afterBigger;
    }

    if (!elementExistsInDOM(target)) {
      return null;
    }

    var parentWithPositionFixed = hasParentWithPositionFixed(target);
    var boundingClientRect = target.getBoundingClientRect();
    var biggerPseudo = isAnyPseudoElementBiggerThanElement(target);
    var computedStyle = window.getComputedStyle(target);
    var outerWidth = computedStyle.overflow === 'visible' ? target.scrollWidth || boundingClientRect.width : target.offsetWidth || boundingClientRect.width;
    var outerHeight = computedStyle.overflow === 'visible' ? target.scrollHeight || boundingClientRect.height : target.offsetHeight || boundingClientRect.height;
    var htmlMarginLeft = parseInt(window.getComputedStyle(document.querySelector('html')).marginLeft.replace('px', ''), 10) || 0;
    var htmlMarginTop = parseInt(window.getComputedStyle(document.querySelector('html')).marginTop.replace('px', ''), 10) || 0;
    var scrollTop = typeof window.scrollY === 'undefined' ? window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0 : window.scrollY;
    var scrollLeft = typeof window.scrollX === 'undefined' ? window.pageXOffset || document.documentElement.scrollTop || document.body.scrollTop || 0 : window.scrollX;
    var coordinates = {
      position: parentWithPositionFixed ? 'fixed' : 'absolute',
      width: (biggerPseudo && biggerPseudo.width || outerWidth) + widthHeightFactor * borderWidth,
      height: (biggerPseudo && biggerPseudo.height || outerHeight) + widthHeightFactor * borderWidth,
      left: boundingClientRect.left + (parentWithPositionFixed ? 0 : scrollLeft) - leftTopFactor * borderWidth - htmlMarginLeft,
      top: boundingClientRect.top + (parentWithPositionFixed ? 0 : scrollTop) - leftTopFactor * borderWidth - htmlMarginTop
    };
    var styling = {
      border: "".concat(borderWidth.toString(), "px solid red"),
      backgroundColor: 'orange',
      'mix-blend-mode': 'difference',
      opacity: 0.2,
      zIndex: 2147483645,
      'min-width': '10px',
      'min-height': '10px'
    };
    return returnOnlyCoords ? coordinates : Object.assign({}, coordinates, styling);
  } // we need computeOverlayStyles without other code to be exported for the extension part
  // but we need computeOverlayStyles in the browser execute too, that's why this happens.


  var addToGlobalVariable = function addToGlobalVariable(computeOverlayStylesFunc) {
    window.trudonGlobals.computeOverlayStyles = computeOverlayStylesFunc;
    return computeOverlayStylesFunc;
  };

  if (returnOnlyComputeOverlayStyles) {
    return computeOverlayStyles;
  }

  if (window.trudonGlobals) {
    return addToGlobalVariable(computeOverlayStyles);
  }
};

var _default = {
  attachComputeOverlayStylesToGlobal: attachComputeOverlayStylesToGlobal,
  computeOverlayStyles: attachComputeOverlayStylesToGlobal(true)
};
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImhpZ2hsaWdodC1oZWxwZXIuanMiXSwibmFtZXMiOlsiYXR0YWNoQ29tcHV0ZU92ZXJsYXlTdHlsZXNUb0dsb2JhbCIsInJldHVybk9ubHlDb21wdXRlT3ZlcmxheVN0eWxlcyIsImNvbXB1dGVPdmVybGF5U3R5bGVzIiwidGFyZ2V0IiwiYm9yZGVyV2lkdGgiLCJ3aWR0aEhlaWdodEZhY3RvciIsImxlZnRUb3BGYWN0b3IiLCJyZXR1cm5Pbmx5Q29vcmRzIiwiZWxlbWVudEV4aXN0c0luRE9NIiwiZWxlbWVudCIsImRvY3VtZW50IiwiYm9keSIsImNvbnRhaW5zIiwiaGFzUGFyZW50V2l0aFBvc2l0aW9uRml4ZWQiLCJnZXRDb21wdXRlZFN0eWxlIiwicG9zaXRpb24iLCJvZmZzZXRQYXJlbnQiLCJpc1BzZXVkb0VsZW1lbnRCaWdnZXIiLCJwc2V1ZG9FbGVtZW50IiwibGVmdCIsInRvcCIsIm1hcmdpbkxlZnQiLCJtYXJnaW5Ub3AiLCJ3aWR0aCIsImhlaWdodCIsImdldEJvdW5kaW5nQ2xpZW50UmVjdCIsImVsZW1lbnRXaWR0aCIsImVsZW1lbnRIZWlnaHQiLCJvZmZzZXRMZWZ0Iiwib2Zmc2V0VG9wIiwiZWxlbWVudExlZnQiLCJlbGVtZW50VG9wIiwiTnVtYmVyIiwiaXNOYU4iLCJwYXJzZUludCIsImRpZmZlcmVuY2VUb3AiLCJkaWZmZXJlbmNlTGVmdCIsIk1hdGgiLCJtYXgiLCJpc0FueVBzZXVkb0VsZW1lbnRCaWdnZXJUaGFuRWxlbWVudCIsImJlZm9yZUJpZ2dlciIsImFmdGVyQmlnZ2VyIiwicGFyZW50V2l0aFBvc2l0aW9uRml4ZWQiLCJib3VuZGluZ0NsaWVudFJlY3QiLCJiaWdnZXJQc2V1ZG8iLCJjb21wdXRlZFN0eWxlIiwid2luZG93Iiwib3V0ZXJXaWR0aCIsIm92ZXJmbG93Iiwic2Nyb2xsV2lkdGgiLCJvZmZzZXRXaWR0aCIsIm91dGVySGVpZ2h0Iiwic2Nyb2xsSGVpZ2h0Iiwib2Zmc2V0SGVpZ2h0IiwiaHRtbE1hcmdpbkxlZnQiLCJxdWVyeVNlbGVjdG9yIiwicmVwbGFjZSIsImh0bWxNYXJnaW5Ub3AiLCJzY3JvbGxUb3AiLCJzY3JvbGxZIiwicGFnZVlPZmZzZXQiLCJkb2N1bWVudEVsZW1lbnQiLCJzY3JvbGxMZWZ0Iiwic2Nyb2xsWCIsInBhZ2VYT2Zmc2V0IiwiY29vcmRpbmF0ZXMiLCJzdHlsaW5nIiwiYm9yZGVyIiwidG9TdHJpbmciLCJiYWNrZ3JvdW5kQ29sb3IiLCJvcGFjaXR5IiwiekluZGV4IiwiT2JqZWN0IiwiYXNzaWduIiwiYWRkVG9HbG9iYWxWYXJpYWJsZSIsImNvbXB1dGVPdmVybGF5U3R5bGVzRnVuYyIsInRydWRvbkdsb2JhbHMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQSxJQUFNQSxrQ0FBa0MsR0FBRyxTQUFyQ0Esa0NBQXFDLEdBQTRDO0FBQUEsTUFBM0NDLDhCQUEyQyx1RUFBVixLQUFVOztBQUNyRixXQUFTQyxvQkFBVCxDQUNFQyxNQURGLEVBRUVDLFdBRkYsRUFNRTtBQUFBLFFBSEFDLGlCQUdBLHVFQUhvQixDQUdwQjtBQUFBLFFBRkFDLGFBRUEsdUVBRmdCLENBRWhCO0FBQUEsUUFEQUMsZ0JBQ0EsdUVBRG1CLEtBQ25COztBQUNBLGFBQVNDLGtCQUFULENBQTRCQyxPQUE1QixFQUFxQztBQUNuQyxhQUFPQyxRQUFRLENBQUNDLElBQVQsQ0FBY0MsUUFBZCxDQUF1QkgsT0FBdkIsQ0FBUDtBQUNEOztBQUVELGFBQVNJLDBCQUFULENBQW9DSixPQUFwQyxFQUE2QztBQUMzQztBQUNBLFNBQUc7QUFDRCxZQUFJSyxnQkFBZ0IsQ0FBQ0wsT0FBRCxDQUFoQixDQUEwQk0sUUFBMUIsS0FBdUMsT0FBM0MsRUFBb0Q7QUFDbEQsaUJBQU8sSUFBUDtBQUNEO0FBQ0YsT0FKRCxRQUlTTixPQUFPLEdBQUdBLE9BQU8sQ0FBQ08sWUFKM0I7O0FBTUEsYUFBTyxLQUFQO0FBQ0Q7QUFFRDtBQUNKO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7O0FBQ0ksYUFBU0MscUJBQVQsQ0FBK0JSLE9BQS9C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QyxNQUFBQSxlQUFlLEVBQUUsUUFGSDtBQUdkLHdCQUFrQixZQUhKO0FBSWRDLE1BQUFBLE9BQU8sRUFBRSxHQUpLO0FBS2RDLE1BQUFBLE1BQU0sRUFBRSxVQUxNO0FBTWQsbUJBQWEsTUFOQztBQU9kLG9CQUFjO0FBUEEsS0FBaEI7QUFVQSxXQUFPaEUsZ0JBQWdCLEdBQUcwRCxXQUFILEdBQWlCTyxNQUFNLENBQUNDLE1BQVAsQ0FDdEMsRUFEc0MsRUFFdENSLFdBRnNDLEVBR3RDQyxPQUhzQyxDQUF4QztBQUtELEdBM0pvRixDQTZKckY7QUFDQTs7O0FBQ0EsTUFBSVEsbUJBQW1CLEdBQUcsU0FBdEJBLG1CQUFzQixDQUFVQyx3QkFBVixFQUFvQztBQUM1RDdCLElBQUFBLE1BQU0sQ0FBQzhCLGFBQVAsQ0FBcUIxRSxvQkFBckIsR0FBNEN5RSx3QkFBNUM7QUFFQSxXQUFPQSx3QkFBUDtBQUNELEdBSkQ7O0FBTUEsTUFBSTFFLDhCQUFKLEVBQW9DO0FBQ2xDLFdBQU9DLG9CQUFQO0FBQ0Q7O0FBRUQsTUFBSTRDLE1BQU0sQ0FBQzhCLGFBQVgsRUFBMEI7QUFDeEIsV0FBT0YsbUJBQW1CLENBQUN4RSxvQkFBRCxDQUExQjtBQUNEO0FBQ0YsQ0E1S0Q7O2VBK0tlO0FBQ2JGLEVBQUFBLGtDQUFrQyxFQUFsQ0Esa0NBRGE7QUFFYkUsRUFBQUEsb0JBQW9CLEVBQUVGLGtDQUFrQyxDQUFDLElBQUQ7QUFGM0MsQyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IGF0dGFjaENvbXB1dGVPdmVybGF5U3R5bGVzVG9HbG9iYWwgPSAocmV0dXJuT25seUNvbXB1dGVPdmVybGF5U3R5bGVzID0gZmFsc2UpID0+IHtcbiAgZnVuY3Rpb24gY29tcHV0ZU92ZXJsYXlTdHlsZXMoXG4gICAgdGFyZ2V0LFxuICAgIGJvcmRlcldpZHRoLFxuICAgIHdpZHRoSGVpZ2h0RmFjdG9yID0gMSxcbiAgICBsZWZ0VG9wRmFjdG9yID0gMSxcbiAgICByZXR1cm5Pbmx5Q29vcmRzID0gZmFsc2VcbiAgKSB7XG4gICAgZnVuY3Rpb24gZWxlbWVudEV4aXN0c0luRE9NKGVsZW1lbnQpIHtcbiAgICAgIHJldHVybiBkb2N1bWVudC5ib2R5LmNvbnRhaW5zKGVsZW1lbnQpO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIGhhc1BhcmVudFdpdGhQb3NpdGlvbkZpeGVkKGVsZW1lbnQpIHtcbiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1jb25kLWFzc2lnblxuICAgICAgZG8ge1xuICAgICAgICBpZiAoZ2V0Q29tcHV0ZWRTdHlsZShlbGVtZW50KS5wb3NpdGlvbiA9PT0gJ2ZpeGVkJykge1xuICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgICB9IHdoaWxlIChlbGVtZW50ID0gZWxlbWVudC5vZmZzZXRQYXJlbnQpO1xuXG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgKiBDaGVja3MgaWYgdGhlIGdpdmVuIHBzZXVkbyBlbGVtZW50IGlzIGJpZ2dlciB0aGFuIHRoZSB0YXJnZXQgZWxlbWVudFxuICAgICogQHBhcmFtIHtFbGVtZW50fSBlbGVtZW50IFRoZSBlbGVtZW50IHRvIGNvbXBhcmUgdGhlIHBzZXVkbyBlbGVtZW50IHdpdGhcbiAgICAqIEBwYXJhbSB7U3RyaW5nfSBwc2V1ZG9FbGVtZW50IE9uZSBvZiAnOmJlZm9yZScgb3IgJzphZnRlcidcbiAgICAqIEByZXR1cm4ge09iamVjdH0gICAgICAgICBPYmplY3QgY29udGFpbmluZyB0b3AsIGxlZnQsIHdpZHRoLCBoZWlnaHQgaW4gcHhcbiAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICA7bnVsbCBpZiBub3QgYmlnZ2VyXG4gICAgKi9cbiAgICBmdW5jdGlvbiBpc1BzZXVkb0VsZW1lbnRCaWdnZXIoZWxlbWVudCwgcHNldWRvRWxlbWVudCkge1xuICAgICAgY29uc3Qge1xuICAgICAgICBsZWZ0LCB0b3AsIG1hcmdpbkxlZnQsIG1hcmdpblRvcCwgd2lkdGgsIGhlaWdodFxuICAgICAgfSA9IGdldENvbXB1dGVkU3R5bGUoZWxlbWVudCwgcHNldWRvRWxlbWVudCk7XG4gICAgICBjb25zdCB7XG4gICAgICAgIHdpZHRoOiBlbGVtZW50V2lkdGgsXG4gICAgICAgIGhlaWdodDogZWxlbWVudEhlaWdodFxuICAgICAgfSA9IGVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG4gICAgICBjb25zdCBbXG4gICAgICAgIGVsZW1lbnRMZWZ0LFxuICAgICAgICBlbGVtZW50VG9wXG4gICAgICBdID0gW1xuICAgICAgICBlbGVtZW50Lm9mZnNldExlZnQsXG4gICAgICAgIGVsZW1lbnQub2Zmc2V0VG9wLFxuICAgICAgXTtcblxuICAgICAgaWYgKFxuICAgICAgICAoTnVtYmVyLmlzTmFOKHBhcnNlSW50KHdpZHRoLCAxMCkpIHx8IHBhcnNlSW50KHdpZHRoLCAxMCkgPD0gZWxlbWVudFdpZHRoXG4gICAgICApICYmIChcbiAgICAgICAgTnVtYmVyLmlzTmFOKHBhcnNlSW50KGhlaWdodCwgMTApKSB8fCBwYXJzZUludChoZWlnaHQsIDEwKSA8PSBlbGVtZW50SGVpZ2h0XG4gICAgICApKSB7XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgICAgfVxuICAgICAgY29uc3QgZGlmZmVyZW5jZVRvcCA9IChwYXJzZUludCh0b3AsIDEwKSB8fCAwKSArXG4gICAgICAgIChwYXJzZUludChtYXJnaW5Ub3AsIDEwKSB8fCAwKTtcbiAgICAgIGNvbnN0IGRpZmZlcmVuY2VMZWZ0ID0gKHBhcnNlSW50KGxlZnQsIDEwKSB8fCAwKSArXG4gICAgICAgIChwYXJzZUludChtYXJnaW5MZWZ0LCAxMCkgfHwgMCk7XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIGxlZnQ6IGVsZW1lbnRMZWZ0ICsgZGlmZmVyZW5jZUxlZnQsXG4gICAgICAgIHRvcDogZWxlbWVudFRvcCArIGRpZmZlcmVuY2VUb3AsXG4gICAgICAgIHdpZHRoOiBNYXRoLm1heChwYXJzZUludCh3aWR0aCwgMTApLCBlbGVtZW50V2lkdGgpIHx8IGVsZW1lbnRXaWR0aCxcbiAgICAgICAgaGVpZ2h0OiBNYXRoLm1heChwYXJzZUludChoZWlnaHQsIDEwKSwgZWxlbWVudEhlaWdodCkgfHwgZWxlbWVudEhlaWdodCxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gaXNBbnlQc2V1ZG9FbGVtZW50QmlnZ2VyVGhhbkVsZW1lbnQodGFyZ2V0KSB7XG4gICAgICBjb25zdCBiZWZvcmVCaWdnZXIgPSBpc1BzZXVkb0VsZW1lbnRCaWdnZXIodGFyZ2V0LCAnOmJlZm9yZScpO1xuICAgICAgY29uc3QgYWZ0ZXJCaWdnZXIgPSBpc1BzZXVkb0VsZW1lbnRCaWdnZXIodGFyZ2V0LCAnOmFmdGVyJyk7XG5cbiAgICAgIGlmIChiZWZvcmVCaWdnZXIgJiYgYWZ0ZXJCaWdnZXIpIHtcbiAgICAgICAgaWYgKGJlZm9yZUJpZ2dlci53aWR0aCAqIGJlZm9yZUJpZ2dlci5oZWlnaHQgPlxuICAgICAgICAgIGFmdGVyQmlnZ2VyLndpZHRoICogYWZ0ZXJCaWdnZXIuaGVpZ2h0XG4gICAgICAgICkge1xuICAgICAgICAgIHJldHVybiBiZWZvcmVCaWdnZXI7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gYWZ0ZXJCaWdnZXI7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBiZWZvcmVCaWdnZXIgfHwgYWZ0ZXJCaWdnZXI7XG4gICAgfVxuICAgIGlmICghZWxlbWVudEV4aXN0c0luRE9NKHRhcmdldCkpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIGNvbnN0IHBhcmVudFdpdGhQb3NpdGlvbkZpeGVkID0gaGFzUGFyZW50V2l0aFBvc2l0aW9uRml4ZWQodGFyZ2V0KTtcbiAgICBjb25zdCBib3VuZGluZ0NsaWVudFJlY3QgPSB0YXJnZXQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG4gICAgY29uc3QgYmlnZ2VyUHNldWRvID0gaXNBbnlQc2V1ZG9FbGVtZW50QmlnZ2VyVGhhbkVsZW1lbnQodGFyZ2V0KTtcbiAgICBjb25zdCBjb21wdXRlZFN0eWxlID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUodGFyZ2V0KTtcblxuICAgIGNvbnN0IG91dGVyV2lkdGggPSBjb21wdXRlZFN0eWxlLm92ZXJmbG93ID09PSAndmlzaWJsZScgP1xuICAgICAgdGFyZ2V0LnNjcm9sbFdpZHRoIHx8IGJvdW5kaW5nQ2xpZW50UmVjdC53aWR0aCA6XG4gICAgICB0YXJnZXQub2Zmc2V0V2lkdGggfHwgYm91bmRpbmdDbGllbnRSZWN0LndpZHRoO1xuICAgIGNvbnN0IG91dGVySGVpZ2h0ID0gY29tcHV0ZWRTdHlsZS5vdmVyZmxvdyA9PT0gJ3Zpc2libGUnID9cbiAgICAgIHRhcmdldC5zY3JvbGxIZWlnaHQgfHwgYm91bmRpbmdDbGllbnRSZWN0LmhlaWdodCA6XG4gICAgICB0YXJnZXQub2Zmc2V0SGVpZ2h0IHx8IGJvdW5kaW5nQ2xpZW50UmVjdC5oZWlnaHQ7XG5cbiAgICBjb25zdCBodG1sTWFyZ2luTGVmdCA9IHBhcnNlSW50KFxuICAgICAgd2luZG93LmdldENvbXB1dGVkU3R5bGUoZG9jdW1lbnQucXVlcnlTZWxlY3RvcignaHRtbCcpKS5tYXJnaW5MZWZ0LnJlcGxhY2UoJ3B4JywgJycpLFxuICAgICAgMTBcbiAgICApIHx8IDA7XG5cbiAgICBjb25zdCBodG1sTWFyZ2luVG9wID0gcGFyc2VJbnQoXG4gICAgICB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZShkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdodG1sJykpLm1hcmdpblRvcC5yZXBsYWNlKCdweCcsICcnKSxcbiAgICAgIDEwXG4gICAgKSB8fCAwO1xuXG4gICAgY29uc3Qgc2Nyb2xsVG9wID0gdHlwZW9mIHdpbmRvdy5zY3JvbGxZID09PSAndW5kZWZpbmVkJyA/XG4gICAgICB3aW5kb3cucGFnZVlPZmZzZXQgfHwgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LnNjcm9sbFRvcCB8fCBkb2N1bWVudC5ib2R5LnNjcm9sbFRvcCB8fCAwIDpcbiAgICAgIHdpbmRvdy5zY3JvbGxZO1xuXG4gICAgY29uc3Qgc2Nyb2xsTGVmdCA9IHR5cGVvZiB3aW5kb3cuc2Nyb2xsWCA9PT0gJ3VuZGVmaW5lZCcgP1xuICAgICAgd2luZG93LnBhZ2VYT2Zmc2V0IHx8IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zY3JvbGxUb3AgfHwgZG9jdW1lbnQuYm9keS5zY3JvbGxUb3AgfHwgMCA6XG4gICAgICB3aW5kb3cuc2Nyb2xsWDtcblxuICAgIGNvbnN0IGNvb3JkaW5hdGVzID0ge1xuICAgICAgcG9zaXRpb246IHBhcmVudFdpdGhQb3NpdGlvbkZpeGVkID8gJ2ZpeGVkJyA6ICdhYnNvbHV0ZScsXG4gICAgICB3aWR0aDogKFxuICAgICAgICBiaWdnZXJQc2V1ZG8gJiYgYmlnZ2VyUHNldWRvLndpZHRoIHx8IG91dGVyV2lkdGhcbiAgICAgICkgKyAoXG4gICAgICAgIHdpZHRoSGVpZ2h0RmFjdG9yICogYm9yZGVyV2lkdGhcbiAgICAgICksXG4gICAgICBoZWlnaHQ6IChcbiAgICAgICAgYmlnZ2VyUHNldWRvICYmIGJpZ2dlclBzZXVkby5oZWlnaHQgfHwgb3V0ZXJIZWlnaHRcbiAgICAgICkgKyAoXG4gICAgICAgIHdpZHRoSGVpZ2h0RmFjdG9yICogYm9yZGVyV2lkdGhcbiAgICAgICksXG4gICAgICBsZWZ0OiAoXG4gICAgICAgIGJvdW5kaW5nQ2xpZW50UmVjdC5sZWZ0ICsgKHBhcmVudFdpdGhQb3NpdGlvbkZpeGVkID8gMCA6IHNjcm9sbExlZnQpXG4gICAgICApIC0gKFxuICAgICAgICBsZWZ0VG9wRmFjdG9yICogYm9yZGVyV2lkdGhcbiAgICAgICkgLSBodG1sTWFyZ2luTGVmdCxcbiAgICAgIHRvcDogKFxuICAgICAgICBib3VuZGluZ0NsaWVudFJlY3QudG9wICsgKHBhcmVudFdpdGhQb3NpdGlvbkZpeGVkID8gMCA6IHNjcm9sbFRvcClcbiAgICAgICkgLSAoXG4gICAgICAgIGxlZnRUb3BGYWN0b3IgKiBib3JkZXJXaWR0aFxuICAgICAgKSAtIGh0bWxNYXJnaW5Ub3AsXG4gICAgfTtcblxuICAgIGNvbnN0IHN0eWxpbmcgPSB7XG4gICAgICBib3JkZXI6IGAke2JvcmRlcldpZHRoLnRvU3RyaW5nKCl9cHggc29saWQgcmVkYCxcbiAgICAgIGJhY2tncm91bmRDb2xvcjogJ29yYW5nZScsXG4gICAgICAnbWl4LWJsZW5kLW1vZGUnOiAnZGlmZmVyZW5jZScsXG4gICAgICBvcGFjaXR5OiAwLjIsXG4gICAgICB6SW5kZXg6IDIxNDc0ODM2NDUsXG4gICAgICAnbWluLXdpZHRoJzogJzEwcHgnLFxuICAgICAgJ21pbi1oZWlnaHQnOiAnMTBweCcsXG4gICAgfVxuXG4gICAgcmV0dXJuIHJldHVybk9ubHlDb29yZHMgPyBjb29yZGluYXRlcyA6IE9iamVjdC5hc3NpZ24oXG4gICAgICB7fSxcbiAgICAgIGNvb3JkaW5hdGVzLFxuICAgICAgc3R5bGluZyxcbiAgICApO1xuICB9XG5cbiAgLy8gd2UgbmVlZCBjb21wdXRlT3ZlcmxheVN0eWxlcyB3aXRob3V0IG90aGVyIGNvZGUgdG8gYmUgZXhwb3J0ZWQgZm9yIHRoZSBleHRlbnNpb24gcGFydFxuICAvLyBidXQgd2UgbmVlZCBjb21wdXRlT3ZlcmxheVN0eWxlcyBpbiB0aGUgYnJvd3NlciBleGVjdXRlIHRvbywgdGhhdCdzIHdoeSB0aGlzIGhhcHBlbnMuXG4gIHZhciBhZGRUb0dsb2JhbFZhcmlhYmxlID0gZnVuY3Rpb24gKGNvbXB1dGVPdmVybGF5U3R5bGVzRnVuYykge1xuICAgIHdpbmRvdy50cnVkb25HbG9iYWxzLmNvbXB1dGVPdmVybGF5U3R5bGVzID0gY29tcHV0ZU92ZXJsYXlTdHlsZXNGdW5jO1xuXG4gICAgcmV0dXJuIGNvbXB1dGVPdmVybGF5U3R5bGVzRnVuYztcbiAgfTtcblxuICBpZiAocmV0dXJuT25seUNvbXB1dGVPdmVybGF5U3R5bGVzKSB7XG4gICAgcmV0dXJuIGNvbXB1dGVPdmVybGF5U3R5bGVzO1xuICB9XG5cbiAgaWYgKHdpbmRvdy50cnVkb25HbG9iYWxzKSB7XG4gICAgcmV0dXJuIGFkZFRvR2xvYmFsVmFyaWFibGUoY29tcHV0ZU92ZXJsYXlTdHlsZXMpO1xuICB9XG59XG5cblxuZXhwb3J0IGRlZmF1bHQge1xuICBhdHRhY2hDb21wdXRlT3ZlcmxheVN0eWxlc1RvR2xvYmFsLFxuICBjb21wdXRlT3ZlcmxheVN0eWxlczogYXR0YWNoQ29tcHV0ZU92ZXJsYXlTdHlsZXNUb0dsb2JhbCh0cnVlKSxcbn07XG4iXSwiZmlsZSI6ImhpZ2hsaWdodC1oZWxwZXIuanMifQ==
