"use strict";

function _typeof(obj) { "@babel/helpers - typeof"; if (typeof Symbol === "function" && typeof Symbol.iterator === "symbol") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; }; } return _typeof(obj); }

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getSelector = getSelector;
exports["default"] = exports.produceSelector = void 0;

var _jquery = _interopRequireDefault(require("jquery"));

var _select = _interopRequireWildcard(require("../../select"));

var _selectorConfiguration = _interopRequireDefault(require("../selector-configuration"));

var _selectWrapper = _interopRequireDefault(require("./select-wrapper"));

var _exceptionsHelper = require("./exceptions-helper");

function _getRequireWildcardCache() { if (typeof WeakMap !== "function") return null; var cache = new WeakMap(); _getRequireWildcardCache = function _getRequireWildcardCache() { return cache; }; return cache; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } if (obj === null || _typeof(obj) !== "object" && typeof obj !== "function") { return { "default": obj }; } var cache = _getRequireWildcardCache(); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj["default"] = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

var defaultSelectorConfig = new _selectorConfiguration["default"]('Default Selector Configuration');
/**
 * Produces the selector and uses fallbacks in case the current config
 * is too restrictive for the current element
 * @param {JQuery} $element  {Jquery} or {Element} if isCalledByRunner is true
 * @param {Object} $customPageDocument
 * @param {SelectorConfig} config
 * @param {Boolean} isCalledByRunner
 * @return {Object}
 */

function produceSelectorFn($element, $customPageDocument, config, isCalledByRunner) {
  // try with the specified config and default strategy
  var sel1 = (0, _selectWrapper["default"])($element, $customPageDocument, config, _select["default"], isCalledByRunner);

  if (!sel1.hasError) {
    return sel1;
  } // try with the fallback config and default strategy


  var sel2 = (0, _selectWrapper["default"])($element, $customPageDocument, null, _select["default"], isCalledByRunner);

  if (!defaultSelectorConfig.isIncludedInConfig(config)) {
    (0, _exceptionsHelper.addWarningMessage)(sel2, _exceptionsHelper.WARNINGS.FELL_TO_DEFAULT_CONFIG);
  }

  if (!sel2.hasError) {
    return sel2;
  } // try with the specified config and the fallback strategy


  var sel3 = (0, _selectWrapper["default"])($element, $customPageDocument, config, _select.getSingleSelector, isCalledByRunner);
  (0, _exceptionsHelper.addWarningMessage)(sel3, _exceptionsHelper.WARNINGS.FELL_TO_DEFAULT_STRATEGY);

  if (!sel3.hasError) {
    return sel3;
  } // try with the fallback config and the fallback strategy


  var sel4 = (0, _selectWrapper["default"])($element, $customPageDocument, null, _select.getSingleSelector, isCalledByRunner);

  if (!defaultSelectorConfig.isIncludedInConfig(config)) {
    (0, _exceptionsHelper.addWarningMessage)(sel4, _exceptionsHelper.WARNINGS.FELL_TO_DEFAULT_CONFIG);
  }

  (0, _exceptionsHelper.addWarningMessage)(sel4, _exceptionsHelper.WARNINGS.FELL_TO_DEFAULT_STRATEGY);

  if (!sel4.hasError) {
    return sel4;
  } // try with tags only config and defaultStrategy


  var tagsOnlyComposition = {
    classes: false,
    ids: false,
    tags: true,
    attributes: false,
    exceptions: Object.assign({}, {
      forbiddenClassSubstrings: config.getForbiddenClassSubstrings()
    }, {
      forbiddenIdSubstrings: config.getForbiddenIdSubstrings()
    }, {
      forbiddenAttributeSubstrings: config.getForbiddenAttributeSubstrings()
    })
  };
  var configTagsOnly = new _selectorConfiguration["default"](config.name, tagsOnlyComposition);
  var sel5 = (0, _selectWrapper["default"])($element, $customPageDocument, configTagsOnly, _select["default"], isCalledByRunner);

  if (!configTagsOnly.isIncludedInConfig(config)) {
    (0, _exceptionsHelper.addWarningMessage)(sel5, _exceptionsHelper.WARNINGS.FELL_TO_DEFAULT_CONFIG);
  }

  if (!sel5.hasError) {
    return sel5;
  }

  logAllInvalidSelectorsError(sel1, sel2, sel3, sel4, sel5);
  return null;
}

function logAllInvalidSelectorsError(sel1, sel2, sel3, sel4, sel5) {
  console.error('[optimal-select-log] All produce selector attempts failed. The selectors are:');
  console.error('[optimal-select-log] userConfig + defaultStrategy', sel1);
  console.error('[optimal-select-log] fallbackConfig + defaultStrategy', sel2);
  console.error('[optimal-select-log] userConfig + fallbackStrategy', sel3);
  console.error('[optimal-select-log] fallbackConfig + fallbackStrategy', sel4);
  console.error('[optimal-select-log] tagsOnlyComposition + defaultStrategy', sel5);
}

function produceSelectorFnWrapper($element, $customPageDocument, config) {
  var isCalledByRunner = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : false;
  var selector = produceSelectorFn($element, $customPageDocument, config, isCalledByRunner);

  if (selector == null) {
    return console.error('[optimal-select-log] Selector is null!');
  }

  if (selector.hasError) {
    console.error('[optimal-select-log] Selector with errors: ', selector.errors);
  }

  if (selector.hasWarning) {
    console.warn('[optimal-select-log] Selector with warnings: ', selector.warnings);
  }

  return selector;
}
/**
* Produces a selector without needing jquery element as param or
* an instance of SelectorConfig(useful for algotech-testing-runner)
*
* @param {HTMLElement}      element
* @param {Object}           config
* @return {Object}                  The generated selector string can be found by the .value
*                                   attribute of this result object.
*/


function getSelector(element, config) {
  var selectorConfig = new _selectorConfiguration["default"]('Global Selector Config', config);
  return produceSelectorFnWrapper(element, window.document, selectorConfig, true);
}

var produceSelector = produceSelectorFnWrapper;
exports.produceSelector = produceSelector;
var _default = {
  produceSelector: produceSelectorFnWrapper
};
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNlbGVjdG9yLWdlbmVyYXRpb24vcHJvZHVjZS1zZWxlY3Rvci9pbmRleC5qcyJdLCJuYW1lcyI6WyJkZWZhdWx0U2VsZWN0b3JDb25maWciLCJTZWxlY3RvckNvbmZpZyIsInByb2R1Y2VTZWxlY3RvckZuIiwiJGVsZW1lbnQiLCIkY3VzdG9tUGFnZURvY3VtZW50IiwiY29uZmlnIiwiaXNDYWxsZWRCeVJ1bm5lciIsInNlbDEiLCJnZXRRdWVyeVNlbGVjdG9yIiwiaGFzRXJyb3IiLCJzZWwyIiwiaXNJbmNsdWRlZEluQ29uZmlnIiwiV0FSTklOR1MiLCJGRUxMX1RPX0RFRkFVTFRfQ09ORklHIiwic2VsMyIsImdldFNpbmdsZVNlbGVjdG9yIiwiRkVMTF9UT19ERUZBVUxUX1NUUkFURUdZIiwic2VsNCIsInRhZ3NPbmx5Q29tcG9zaXRpb24iLCJjbGFzc2VzIiwiaWRzIiwidGFncyIsImF0dHJpYnV0ZXMiLCJleGNlcHRpb25zIiwiT2JqZWN0IiwiYXNzaWduIiwiZm9yYmlkZGVuQ2xhc3NTdWJzdHJpbmdzIiwiZ2V0Rm9yYmlkZGVuQ2xhc3NTdWJzdHJpbmdzIiwiZm9yYmlkZGVuSWRTdWJzdHJpbmdzIiwiZ2V0Rm9yYmlkZGVuSWRTdWJzdHJpbmdzIiwiZm9yYmlkZGVuQXR0cmlidXRlU3Vic3RyaW5ncyIsImdldEZvcmJpZGRlbkF0dHJpYnV0ZVN1YnN0cmluZ3MiLCJjb25maWdUYWdzT25seSIsIm5hbWUiLCJzZWw1IiwibG9nQWxsSW52YWxpZFNlbGVjdG9yc0Vycm9yIiwiY29uc29sZSIsImVycm9yIiwicHJvZHVjZVNlbGVjdG9yRm5XcmFwcGVyIiwic2VsZWN0b3IiLCJlcnJvcnMiLCJoYXNXYXJuaW5nIiwid2FybiIsIndhcm5pbmdzIiwiZ2V0U2VsZWN0b3IiLCJlbGVtZW50Iiwic2VsZWN0b3JDb25maWciLCJ3aW5kb3ciLCJkb2N1bWVudCIsInByb2R1Y2VTZWxlY3RvciJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7OztBQUFBOztBQUNBOztB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QU8sQ0FBQ0MsS0FBUixDQUFjLDZDQUFkLEVBQTZERSxRQUFRLENBQUNDLE1BQXRFO0FBQ0Q7O0FBQ0QsTUFBSUQsUUFBUSxDQUFDRSxVQUFiLEVBQXlCO0FBQ3ZCTCxJQUFBQSxPQUFPLENBQUNNLElBQVIsQ0FBYSwrQ0FBYixFQUE4REgsUUFBUSxDQUFDSSxRQUF2RTtBQUNEOztBQUVELFNBQU9KLFFBQVA7QUFDRDtBQUVEOzs7Ozs7Ozs7OztBQVNPLFNBQVNLLFdBQVQsQ0FBcUJDLE9BQXJCLEVBQThCeEMsTUFBOUIsRUFBc0M7QUFDM0MsTUFBTXlDLGNBQWMsR0FBRyxJQUFJN0MsaUNBQUosQ0FBbUIsd0JBQW5CLEVBQTZDSSxNQUE3QyxDQUF2QjtBQUVBLFNBQU9pQyx3QkFBd0IsQ0FBQ08sT0FBRCxFQUFVRSxNQUFNLENBQUNDLFFBQWpCLEVBQTJCRixjQUEzQixFQUEyQyxJQUEzQyxDQUEvQjtBQUNEOztBQUVNLElBQU1HLGVBQWUsR0FBR1gsd0JBQXhCOztlQUVRO0FBQ2JXLEVBQUFBLGVBQWUsRUFBRVg7QUFESixDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICQgZnJvbSAnanF1ZXJ5JztcbmltcG9ydCBnZXRRdWVyeVNlbGVjdG9yLCB7IGdldFNpbmdsZVNlbGVjdG9yIH0gZnJvbSAnLi4vLi4vc2VsZWN0JztcblxuaW1wb3J0IFNlbGVjdG9yQ29uZmlnIGZyb20gJy4uL3NlbGVjdG9yLWNvbmZpZ3VyYXRpb24nO1xuaW1wb3J0IHNlbGVjdCBmcm9tICcuL3NlbGVjdC13cmFwcGVyJztcbmltcG9ydCB7IGFkZFdhcm5pbmdNZXNzYWdlLCBXQVJOSU5HUyB9IGZyb20gJy4vZXhjZXB0aW9ucy1oZWxwZXInO1xuXG5jb25zdCBkZWZhdWx0U2VsZWN0b3JDb25maWcgPSBuZXcgU2VsZWN0b3JDb25maWcoXG4gICdEZWZhdWx0IFNlbGVjdG9yIENvbmZpZ3VyYXRpb24nXG4pO1xuXG4vKipcbiAqIFByb2R1Y2VzIHRoZSBzZWxlY3RvciBhbmQgdXNlcyBmYWxsYmFja3MgaW4gY2FzZSB0aGUgY3VycmVudCBjb25maWdcbiAqIGlzIHRvbyByZXN0cmljdGl2ZSBmb3IgdGhlIGN1cnJlbnQgZWxlbWVudFxuICogQHBhcmFtIHtKUXVlcnl9ICRlbGVtZW50ICB7SnF1ZXJ5fSBvciB7RWxlbWVudH0gaWYgaXNDYWxsZWRCeVJ1bm5lciBpcyB0cnVlXG4gKiBAcGFyYW0ge09iamVjdH0gJGN1c3RvbVBhZ2VEb2N1bWVudFxuICogQHBhcmFtIHtTZWxlY3RvckNvbmZpZ30gY29uZmlnXG4gKiBAcGFyYW0ge0Jvb2xlYW59IGlzQ2FsbGVkQnlSdW5uZXJcbiAqIEByZXR1cm4ge09iamVjdH1cbiAqL1xuZnVuY3Rpb24gcHJvZHVjZVNlbGVjdG9yRm4oJGVsZW1lbnQsICRjdXN0b21QYWdlRG9jdW1lbnQsIGNvbmZpZywgaXNDYWxsZWRCeVJ1bm5lcikge1xuICAvLyB0cnkgd2l0aCB0aGUgc3BlY2lmaWVkIGNvbmZpZyBhbmQgZGVmYXVsdCBzdHJhdGVneVxuICBsZXQgc2VsMSA9IHNlbGVjdCgkZWxlbWVudCwgJGN1c3RvbVBhZ2VEb2N1bWVudCwgY29uZmlnLCBnZXRRdWVyeVNlbGVjdG9yLCBpc0NhbGxlZEJ5UnVubmVyKTtcblxuICBpZiAoIXNlbDEuaGFzRXJyb3IpIHtcbiAgICByZXR1cm4gc2VsMTtcbiAgfVxuXG4gIC8vIHRyeSB3aXRoIHRoZSBmYWxsYmFjayBjb25maWcgYW5kIGRlZmF1bHQgc3RyYXRlZ3lcbiAgbGV0IHNlbDIgPSBzZWxlY3QoJGVsZW1lbnQsICRjdXN0b21QYWdlRG9jdW1lbnQsIG51bGwsIGdldFF1ZXJ5U2VsZWN0b3IsIGlzQ2FsbGVkQnlSdW5uZXIpO1xuXG4gIGlmICghZGVmYXVsdFNlbGVjdG9yQ29uZmlnLmlzSW5jbHVkZWRJbkNvbmZpZyhjb25maWcpKSB7XG4gICAgYWRkV2FybmluZ01lc3NhZ2Uoc2VsMiwgV0FSTklOR1MuRkVMTF9UT19ERUZBVUxUX0NPTkZJRyk7XG4gIH1cblxuICBpZiAoIXNlbDIuaGFzRXJyb3IpIHtcbiAgICByZXR1cm4gc2VsMjtcbiAgfVxuXG4gIC8vIHRyeSB3aXRoIHRoZSBzcGVjaWZpZWQgY29uZmlnIGFuZCB0aGUgZmFsbGJhY2sgc3RyYXRlZ3lcbiAgbGV0IHNlbDMgPSBzZWxlY3QoJGVsZW1lbnQsICRjdXN0b21QYWdlRG9jdW1lbnQsIGNvbmZpZywgZ2V0U2luZ2xlU2VsZWN0b3IsIGlzQ2FsbGVkQnlSdW5uZXIpO1xuXG4gIGFkZFdhcm5pbmdNZXNzYWdlKHNlbDMsIFdBUk5JTkdTLkZFTExfVE9fREVGQVVMVF9TVFJBVEVHWSk7XG5cbiAgaWYgKCFzZWwzLmhhc0Vycm9yKSB7XG4gICAgcmV0dXJuIHNlbDM7XG4gIH1cblxuICAvLyB0cnkgd2l0aCB0aGUgZmFsbGJhY2sgY29uZmlnIGFuZCB0aGUgZmFsbGJhY2sgc3RyYXRlZ3lcbiAgbGV0IHNlbDQgPSBzZWxlY3QoJGVsZW1lbnQsICRjdXN0b21QYWdlRG9jdW1lbnQsIG51bGwsIGdldFNpbmdsZVNlbGVjdG9yLCBpc0NhbGxlZEJ5UnVubmVyKTtcblxuICBpZiAoIWRlZmF1bHRTZWxlY3RvckNvbmZpZy5pc0luY2x1ZGVkSW5Db25maWcoY29uZmlnKSkge1xuICAgIGFkZFdhcm5pbmdNZXNzYWdlKHNlbDQsIFdBUk5JTkdTLkZFTExfVE9fREVGQVVMVF9DT05GSUcpO1xuICB9XG4gIGFkZFdhcm5pbmdNZXNzYWdlKHNlbDQsIFdBUk5JTkdTLkZFTExfVE9fREVGQVVMVF9TVFJBVEVHWSk7XG5cbiAgaWYgKCFzZWw0Lmhhc0Vycm9yKSB7XG4gICAgcmV0dXJuIHNlbDQ7XG4gIH1cblxuICAvLyB0cnkgd2l0aCB0YWdzIG9ubHkgY29uZmlnIGFuZCBkZWZhdWx0U3RyYXRlZ3lcbiAgbGV0IHRhZ3NPbmx5Q29tcG9zaXRpb24gPSB7XG4gICAgY2xhc3NlczogZmFsc2UsXG4gICAgaWRzOiBmYWxzZSxcbiAgICB0YWdzOiB0cnVlLFxuICAgIGF0dHJpYnV0ZXM6IGZhbHNlLFxuICAgIGV4Y2VwdGlvbnM6IE9iamVjdC5hc3NpZ24oXG4gICAgICB7fSxcbiAgICAgIHsgZm9yYmlkZGVuQ2xhc3NTdWJzdHJpbmdzOiBjb25maWcuZ2V0Rm9yYmlkZGVuQ2xhc3NTdWJzdHJpbmdzKCkgfSxcbiAgICAgIHsgZm9yYmlkZGVuSWRTdWJzdHJpbmdzOiBjb25maWcuZ2V0Rm9yYmlkZGVuSWRTdWJzdHJpbmdzKCkgfSxcbiAgICAgIHsgZm9yYmlkZGVuQXR0cmlidXRlU3Vic3RyaW5nczogY29uZmlnLmdldEZvcmJpZGRlbkF0dHJpYnV0ZVN1YnN0cmluZ3MoKSB9XG4gICAgKVxuICB9O1xuICBsZXQgY29uZmlnVGFnc09ubHkgPSBuZXcgU2VsZWN0b3JDb25maWcoY29uZmlnLm5hbWUsIHRhZ3NPbmx5Q29tcG9zaXRpb24pO1xuICBsZXQgc2VsNSA9XG4gICAgc2VsZWN0KCRlbGVtZW50LCAkY3VzdG9tUGFnZURvY3VtZW50LCBjb25maWdUYWdzT25seSwgZ2V0UXVlcnlTZWxlY3RvciwgaXNDYWxsZWRCeVJ1bm5lcik7XG5cbiAgaWYgKCFjb25maWdUYWdzT25seS5pc0luY2x1ZGVkSW5Db25maWcoY29uZmlnKSkge1xuICAgIGFkZFdhcm5pbmdNZXNzYWdlKHNlbDUsIFdBUk5JTkdTLkZFTExfVE9fREVGQVVMVF9DT05GSUcpO1xuICB9XG5cbiAgaWYgKCFzZWw1Lmhhc0Vycm9yKSB7XG4gICAgcmV0dXJuIHNlbDU7XG4gIH1cblxuICBsb2dBbGxJbnZhbGlkU2VsZWN0b3JzRXJyb3Ioc2VsMSwgc2VsMiwgc2VsMywgc2VsNCwgc2VsNSk7XG5cbiAgcmV0dXJuIG51bGw7XG59XG5cbmZ1bmN0aW9uIGxvZ0FsbEludmFsaWRTZWxlY3RvcnNFcnJvcihzZWwxLCBzZWwyLCBzZWwzLCBzZWw0LCBzZWw1KSB7XG4gIGNvbnNvbGUuZXJyb3IoJ1tvcHRpbWFsLXNlbGVjdC1sb2ddIEFsbCBwcm9kdWNlIHNlbGVjdG9yIGF0dGVtcHRzIGZhaWxlZC4gVGhlIHNlbGVjdG9ycyBhcmU6Jyk7XG4gIGNvbnNvbGUuZXJyb3IoJ1tvcHRpbWFsLXNlbGVjdC1sb2ddIHVzZXJDb25maWcgKyBkZWZhdWx0U3RyYXRlZ3knLCBzZWwxKTtcbiAgY29uc29sZS5lcnJvcignW29wdGltYWwtc2VsZWN0LWxvZ10gZmFsbGJhY2tDb25maWcgKyBkZWZhdWx0U3RyYXRlZ3knLCBzZWwyKTtcbiAgY29uc29sZS5lcnJvcignW29wdGltYWwtc2VsZWN0LWxvZ10gdXNlckNvbmZpZyArIGZhbGxiYWNrU3RyYXRlZ3knLCBzZWwzKTtcbiAgY29uc29sZS5lcnJvcignW29wdGltYWwtc2VsZWN0LWxvZ10gZmFsbGJhY2tDb25maWcgKyBmYWxsYmFja1N0cmF0ZWd5Jywgc2VsNCk7XG4gIGNvbnNvbGUuZXJyb3IoJ1tvcHRpbWFsLXNlbGVjdC1sb2ddIHRhZ3NPbmx5Q29tcG9zaXRpb24gKyBkZWZhdWx0U3RyYXRlZ3knLCBzZWw1KTtcbn1cblxuZnVuY3Rpb24gcHJvZHVjZVNlbGVjdG9yRm5XcmFwcGVyKCRlbGVtZW50LCAkY3VzdG9tUGFnZURvY3VtZW50LCBjb25maWcsIGlzQ2FsbGVkQnlSdW5uZXIgPSBmYWxzZSkge1xuICBsZXQgc2VsZWN0b3IgPSBwcm9kdWNlU2VsZWN0b3JGbigkZWxlbWVudCwgJGN1c3RvbVBhZ2VEb2N1bWVudCwgY29uZmlnLCBpc0NhbGxlZEJ5UnVubmVyKTtcblxuICBpZiAoc2VsZWN0b3IgPT0gbnVsbCkge1xuICAgIHJldHVybiBjb25zb2xlLmVycm9yKCdbb3B0aW1hbC1zZWxlY3QtbG9nXSBTZWxlY3RvciBpcyBudWxsIScpO1xuICB9XG4gIGlmIChzZWxlY3Rvci5oYXNFcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoJ1tvcHRpbWFsLXNlbGVjdC1sb2ddIFNlbGVjdG9yIHdpdGggZXJyb3JzOiAnLCBzZWxlY3Rvci5lcnJvcnMpO1xuICB9XG4gIGlmIChzZWxlY3Rvci5oYXNXYXJuaW5nKSB7XG4gICAgY29uc29sZS53YXJuKCdbb3B0aW1hbC1zZWxlY3QtbG9nXSBTZWxlY3RvciB3aXRoIHdhcm5pbmdzOiAnLCBzZWxlY3Rvci53YXJuaW5ncyk7XG4gIH1cblxuICByZXR1cm4gc2VsZWN0b3I7XG59XG5cbi8qKlxuKiBQcm9kdWNlcyBhIHNlbGVjdG9yIHdpdGhvdXQgbmVlZGluZyBqcXVlcnkgZWxlbWVudCBhcyBwYXJhbSBvclxuKiBhbiBpbnN0YW5jZSBvZiBTZWxlY3RvckNvbmZpZyh1c2VmdWwgZm9yIGFsZ290ZWNoLXRlc3RpbmctcnVubmVyKVxuKlxuKiBAcGFyYW0ge0hUTUxFbGVtZW50fSAgICAgIGVsZW1lbnRcbiogQHBhcmFtIHtPYmplY3R9ICAgICAgICAgICBjb25maWdcbiogQHJldHVybiB7T2JqZWN0fSAgICAgICAgICAgICAgICAgIFRoZSBnZW5lcmF0ZWQgc2VsZWN0b3Igc3RyaW5nIGNhbiBiZSBmb3VuZCBieSB0aGUgLnZhbHVlXG4qICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdHRyaWJ1dGUgb2YgdGhpcyByZXN1bHQgb2JqZWN0LlxuKi9cbmV4cG9ydCBmdW5jdGlvbiBnZXRTZWxlY3RvcihlbGVtZW50LCBjb25maWcpIHtcbiAgY29uc3Qgc2VsZWN0b3JDb25maWcgPSBuZXcgU2VsZWN0b3JDb25maWcoJ0dsb2JhbCBTZWxlY3RvciBDb25maWcnLCBjb25maWcpO1xuXG4gIHJldHVybiBwcm9kdWNlU2VsZWN0b3JGbldyYXBwZXIoZWxlbWVudCwgd2luZG93LmRvY3VtZW50LCBzZWxlY3RvckNvbmZpZywgdHJ1ZSk7XG59XG5cbmV4cG9ydCBjb25zdCBwcm9kdWNlU2VsZWN0b3IgPSBwcm9kdWNlU2VsZWN0b3JGbldyYXBwZXI7XG5cbmV4cG9ydCBkZWZhdWx0IHtcbiAgcHJvZHVjZVNlbGVjdG9yOiBwcm9kdWNlU2VsZWN0b3JGbldyYXBwZXJcbn07XG4iXSwiZmlsZSI6InNlbGVjdG9yLWdlbmVyYXRpb24vcHJvZHVjZS1zZWxlY3Rvci9pbmRleC5qcyJ9
